"use strict";function _classCallCheck(o,a){if(!(o instanceof a))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function o(o,a){for(var t,e=0;e<a.length;e++)t=a[e],t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(o,t.key,t)}return function(a,t,e){return t&&o(a.prototype,t),e&&o(a,e),a}}();!function(o){o.module("alt.importacao-csv",["alt.modal-service","alt.select-service","alt.alerta-flutuante","alt.carregando-info"]).constant("AltImportacaoCsvEvento",{modal:{ABRE_MODAL_IMPORTACAO_ESPECIFICA:"alt-importacao-csv:abrir_modal_importacao_especifica"},processamento:{ATUALIZAR_LOTE:"alt-importacao-csv:atualizar_processamento_lote"}}).constant("latinize",latinize).constant("_",_).constant("moment",moment).constant("XLS",XLS).constant("XLSX",XLSX)}(angular),function(o){o.module("alt.importacao-csv").filter("LimitadorTexto",["_",function(o){return function(a,t){if(a){var e=t||53;return a.length>e&&(a=o.truncate(a,{length:e})),"string"==typeof a?a.trim():a}}}])}(angular),function(o){o.module("alt.importacao-csv").directive("altImportacaoCsvContador",["$timeout",function(o){return{scope:{countFrom:"=",countTo:"=",duration:"@"},link:function(a,t,e){var s=t[0],i=void 0,r=void 0,n=void 0,l=void 0,c=void 0,p=void 0,m=void 0,d=function(){r=30,c=0,a.timoutId=null,p=parseInt(a.countTo)||0,a.value=parseInt(a.countFrom)||0,n=1e3*parseFloat(e.duration)||0,l=Math.ceil(n/r),m=(p-a.value)/l,i=a.value},v=function(){a.timoutId=o(function(){i+=m,c++,c>=l?(o.cancel(a.timoutId),i=p,s.textContent=p):(s.textContent=Math.round(i),v())},r)},u=function(){a.timoutId&&o.cancel(a.timoutId),d(),v()};return a.$watch("countTo",function(o){!o||u()}),!0}}}])}(angular),function(o){o.module("alt.importacao-csv").service("AltImportacaoCsvEspecificaService",["$rootScope","AltImportacaoCsvEvento",function(o,a){this.exibe=function(t){o.$broadcast(a.modal.ABRE_MODAL_IMPORTACAO_ESPECIFICA,t)},this.atualizarProcessamento=function(t){o.$broadcast(a.processamento.ATUALIZAR_LOTE,t)}}]).directive("altImportacaoCsvEspecifica",[function(){return{restrict:"A",replace:!0,template:'\n  <div class="modal fade"\n    id="alt-importacao-csv-modal"\n    role="dialog"\n    aria-hidden="true">\n\n    <div class="modal-dialog modal-lg modal-xl-custom">\n      <div class="modal-content">\n\n        <div class="modal-header alt-cor-principal">\n          <button type="button" class="close" ng-click="importacaoCsvCtrl.limparImportacao()">\n            <i class="fa fa-times"></i><span class="sr-only">Close</span>\n          </button>\n\n          <h3 class="modal-title">\n            {{!importacaoCsvCtrl.visualizacao ? \'Nova\' : \'Detalhes da\'}}\n            importação - <span>{{importacaoCsvCtrl.labelTipo}}</span></h3>\n        </div>\n        <div class="alt-importacao-csv-wizard-menu">\n          <div class="modal-body" ng-hide="importacaoCsvCtrl.visualizacao">\n            <div class="row">\n              <div ng-repeat="step in importacaoCsvCtrl.steps"\n                      class="text-center alt-importacao-csv-step-title-wrap"\n                      ng-class="{\'col-xs-4\': !!importacaoCsvCtrl.exibeEtapaRegras, \'col-xs-6\': !importacaoCsvCtrl.exibeEtapaRegras}"\n                      ng-hide="step.menuHidden">\n                <div class="row">\n                  <div class="col-xs-12">\n                    <button type="button" class="alt-importacao-csv-step-title" \n                      ng-class="{\n                        \'alt-importacao-csv-step-title-completed\': step.completed, \n                        \'alt-importacao-csv-step-title-active\': step.active,\n                        \'alt-importacao-csv-step-title-invalid\': !step.valid}">\n                        {{step.number}}\n                    </button>\n                  </div>\n                </div>\n                <div class="row">\n                  <div class="col-xs-12 alt-importacao-csv-step-subtitle"\n                    ng-class="{\n                      \'alt-importacao-csv-step-subtitle-completed\': step.completed, \n                      \'alt-importacao-csv-step-subtitle-active\': step.active,\n                      \'alt-importacao-csv-step-subtitle-invalid\': !step.valid}">\n                    <span class="text-uppercase text-center">{{step.name}}</span>\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div class="row">\n              <div class="col-xs-12 alt-importacao-csv-progress-wrapper">\n                <uib-progressbar class="progress-striped" value="importacaoCsvCtrl.progress" type="info">\n                </uib-progressbar>\n              </div>\n            </div>\n          </div>\n\n        </div>\n        <div class="alt-importacao-csv-wrapper">\n          <div ng-show="importacaoCsvCtrl.steps[0].active"\n            class="alt-importacao-csv-wizard-step">\n            <div class="modal-body">\n              <form name="importacaoCsvCtrl.formStepOne">\n                <div class="row">\n                  <div class="col-xs-12">\n                    <div class="alt-importacao-csv-wizard-title" ng-bind="importacaoCsvCtrl.getTitle()"></div>\n                    <p class="alt-importacao-csv-wizard-obs alt-espacamento-top" ng-bind-html="importacaoCsvCtrl.getMessage()"><p>\n                    <div class="alt-espacamento-top alt-espacamento-bottom clearfix">\n                        <div class="col-xs-12 col-sm-4 col-sm-offset-4 anexos-input-file-escondido-container text-center">\n                          <button type="button" class="btn btn-block btn-default alt-espacamento-bottom alt-espacamento-top anexos-input-file-fake">\n                            Selecionar arquivo\n                          </button>\n                          <span class="small microcopy text-muted">Tamanho máximo: 2MB ou 3.000 registros</span>\n\n                          <input type="file" class="anexos-input-file-real alt-hand ng-isolate-scope" \n                            ng-model="importacaoCsvCtrl.arquivo" \n                            id="alt-importacao-csv-input-file-step1"\n                            accept=".xls,.xlsx,.csv,.ods"\n                            alt-importacao-csv-leitor\n                            data-opts="importacaoCsvCtrl.arquivoOpcoes"\n                            ng-change="importacaoCsvCtrl.arquivoAlterado()"\n                            required>\n                        </div>\n                    </div>\n                    <div class="text-center" ng-show="!!importacaoCsvCtrl.arquivo && importacaoCsvCtrl.arquivo.valido">\n                      <span class="text-success alt-importacao-csv-input-ckeck">\n                        <i class="fa fa-check-circle"></i> {{importacaoCsvCtrl.arquivo.nome}}\n                      </span>\n                    </div>\n\n                    <div class="text-center" ng-show="!!importacaoCsvCtrl.arquivo && !importacaoCsvCtrl.arquivo.valido">\n                      <span class="text-muted alt-importacao-csv-input-ckeck" ng-hide="importacaoCsvCtrl.exibirMensagemErro">\n                        <i class="fa fa-check-circle"></i> {{importacaoCsvCtrl.arquivo.nome}}\n                      </span>\n                    </div>\n\n                    <div class="alert alert-danger alert-dismissible alt-espacamento-bottom" role="alert" ng-show="importacaoCsvCtrl.exibirMensagemErro">\n                      <button type="button" ng-click="importacaoCsvCtrl.removerMensagemErro()" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n                      \n                      <div class="" ng-show="!!importacaoCsvCtrl.arquivo && !importacaoCsvCtrl.arquivo.valido">\n                        <span class="text-danger alt-importacao-csv-input-ckeck">\n                          <i class="fa fa-exclamation-triangle"></i> {{importacaoCsvCtrl.arquivo.mensagem}}\n                        </span>\n                      </div>\n                      <div class="" ng-show="!importacaoCsvCtrl.arquivo && importacaoCsvCtrl.exibirMensagemErro">\n                        <span class="alt-importacao-csv-input-ckeck">\n                          <i class="fa fa-exclamation-triangle"></i> Selecione um arquivo para prosseguir\n                        </span>\n                      </div>\n\n                    </div>\n\n\n                  </div>\n                </div>\n              </form>\n            </div>\n          </div>\n          <div ng-show="importacaoCsvCtrl.steps[1].active"\n            class="alt-importacao-csv-wizard-step">\n            <div class="modal-body">\n              <div class="row">\n                <div class="col-xs-12">\n                  <div class="alt-importacao-csv-wizard-title" ng-bind="importacaoCsvCtrl.getTitle()"></div>\n                  <div class="alt-espacamento-bottom" ng-bind-html="importacaoCsvCtrl.getMessage()"></div>\n                </div>\n              </div>\n \n              <div class="row">\n                <div class="col-xs-12 alt-espacamento-top">\n                  <div class="alt-importacao-csv-planilha-mapeamento">\n                    <table class="table">\n                      <thead>\n                        <tr>\n                          <th ng-repeat="coluna in importacaoCsvCtrl.importacao.colunas" ng-class="{\'alt-importacao-csv-coluna-possui-campo-mapeado\': !!coluna.campos && coluna.campos.length}">\n                            <select class="alt-importacao-csv-select-field"\n                              name="field"\n                              data-placeholder="Selecione"\n                              ng-model="coluna.campoSelecionado"\n                              ng-change="importacaoCsvCtrl.vincular(coluna.campoSelecionado, coluna.numero)"\n                              ng-options="campo.chave as campo.nome group by campo.grupo for campo in importacaoCsvCtrl.importacao.campos | filter: importacaoCsvCtrl.campoNaoMapeado track by campo.chave">\n                              <option value=""></option>\n                            </select>\n                          </th>\n                        </tr>\n                      </thead>\n                      <thead>\n                        <tr>\n                          <th ng-repeat="coluna in importacaoCsvCtrl.importacao.colunas" ng-class="{\'alt-importacao-csv-coluna-possui-campo-mapeado\': !!coluna.campos && coluna.campos.length}">\n                            <span class="small"><i ng-show="coluna.campos.length == 0">Nenhum campo selecionado</i></span>\n\n                            <div ng-repeat="c in coluna.campos" class="alt-importacao-csv-lb-campo-mapeado">\n                              <b>{{c.nome}}</b>\n                              <span ng-click="importacaoCsvCtrl.desvincular(c.chave)" title="Desvincular">\n                                <i class="fa fa-times"></i>\n                              </span>\n                            </div>\n\n                          </th>\n                        </tr>\n                      </thead>\n                      <tbody class="cabecalho-planilha" ng-show="importacaoCsvCtrl.arquivoOpcoes.colunasPossuemTitulos">\n                        <tr>\n                          <td ng-repeat="coluna in importacaoCsvCtrl.importacao.colunas">\n                            {{coluna.nome}}\n                          </td>\n                        </tr>\n                      </tbody>\n                      <tbody>\n                        <tr ng-repeat="linha in importacaoCsvCtrl.arquivo.dezPrimeirasLinhas">\n                          <td ng-repeat="coluna in importacaoCsvCtrl.arquivo.colunas track by $index" \n                            ng-class="{\'alt-importacao-csv-coluna-possui-campo-mapeado\': !!importacaoCsvCtrl.importacao.colunas[$index].campos && importacaoCsvCtrl.importacao.colunas[$index].campos.length}">\n                            {{importacaoCsvCtrl.formatarLinhaValor(linha[coluna]).toString() | LimitadorTexto:40}}\n                          </td>\n                        </tr>\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n              </div>\n\n              <div class="row">\n                <div class="col-xs-12 alt-espacamento-bottom">\n                  <label class="alt-hand alt-espacamento-top" ng-show="importacaoCsvCtrl.arquivo.linhas.length > 1 || importacaoCsvCtrl.arquivoOpcoes.colunasPossuemTitulos">\n                    <input type="checkbox"\n                        ng-model="importacaoCsvCtrl.arquivoOpcoes.colunasPossuemTitulos"/>\n                    <span class="alt-checkbox"></span> <span class="alt-checkbox-label">Primeira linha do arquivo são títulos das colunas</span>\n                  </label>\n                </div> \n              </div>\n\n              <div class="row">\n                <div class="col-xs-12 alt-importacao-csv-map-warnings">\n                  <div class="alert alert-danger alert-dismissible alt-espacamento-bottom" role="alert" ng-show="importacaoCsvCtrl.importacao.mapaInvalido && importacaoCsvCtrl.exibirMensagemErro">\n                    <button type="button" ng-click="importacaoCsvCtrl.removerMensagemErro()" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n                    <p ng-repeat="campo in importacaoCsvCtrl.importacao.campos" ng-if="campo.vinculoRequisitado && !campo.valido">\n                      <i class="fa fa-exclamation-triangle"></i>\n                      <span>O campo <b>{{campo.nome}}</b> do ERP4ME deve ser vinculado a uma coluna do arquivo</span>\n                    </p>\n                  </div>\n                </div>\n              </div>\n\n            </div>\n          </div>\n          <div ng-show="importacaoCsvCtrl.steps[2].active"\n            class="alt-importacao-csv-wizard-step">\n            <div class="modal-body">\n              <div class="row">\n                <div class="col-xs-12">\n                  <div class="alt-importacao-csv-wizard-title" ng-bind="importacaoCsvCtrl.getTitle()"></div>\n                  <div class="alt-espacamento-bottom" ng-bind-html="importacaoCsvCtrl.getMessage()"></div>\n                </div>\n              </div>\n              \n              <div class="row alt-espacamento-top">\n                <div class="col-xs-12 alt-importacao-csv-rules-field" \n                  ng-repeat="campo in importacaoCsvCtrl.importacao.campos track by campo.chave" \n                  ng-if="campo.tipo.name === \'Object\'"\n                  ng-hide="\n                    (importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'regras\' && campo.resumoRegrasDeValor.vinculados === 0) ||\n                    (importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosInvalidos\' && campo.resumoRegrasDeValor.nulosInvalidos === 0) ||\n                    (importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosValidos\' && campo.resumoRegrasDeValor.nulosValidos === 0) ||\n                    (!campo.obrigatorio && campo.coluna === undefined)">\n                  <div class="row alt-espacamento-top">\n                    <div class="col-xs-12">\n                      <label ng-show="importacaoCsvCtrl.obterQtdCamposRegras(importacaoCsvCtrl.importacao.campos) > 1" class="alt-importacao-csv-rules-title" data-toggle="collapse" data-target="#alt-importacao-csv-rules-field-{{campo.chave}}">\n                        <i class="fa fa-angle-down"></i>\n                        {{campo.nome}} \n                        <span ng-show="!!campo.coluna && importacaoCsvCtrl.arquivoOpcoes.colunasPossuemTitulos">(coluna {{importacaoCsvCtrl.nomeColuna(campo.coluna)}})</span>\n                      </label>\n                    </div>\n                  </div>\n                  <div class="alt-importacao-csv-rule-table-overflow">\n                    <div class="row alt-espacamento-bottom collapse in" id="alt-importacao-csv-rules-field-{{campo.chave}}">\n                      <div class="col-xs-12 alt-importacao-csv-rule-table">\n                        <table class="table table-responsive table-condensed table-striped">\n                          <thead>\n                            <tr>\n                              <th class="status"></th>\n                              <th>Informação arquivo</th>\n                              <th>Ocorrências</th>\n                              <th>{{campo.nome}}</th>\n                              <th></th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="regra in campo.regrasDeValor"\n                              ng-class="{\n                                \'rule-success\': regra.objeto,\n                                \'rule-warning\': !regra.objeto && !campo.obrigatorio,\n                                \'rule-error\': !regra.objeto && campo.obrigatorio}"\n                              ng-hide="\n                                (!regra.objeto && importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'regras\') ||\n                                ((!regra.objeto && campo.obrigatorio || regra.objeto) && importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosValidos\') ||\n                                ((!regra.objeto && !campo.obrigatorio || regra.objeto) && importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosInvalidos\')">\n                              <td class="status">\n                                <i class="fa fa-exclamation-triangle text-warning" ng-show="!regra.objeto && campo.obrigatorio" title="Vínculo obrigatório"></i>\n                                <i class="fa fa-check text-success" ng-show="regra.objeto"></i>\n                              </td>\n                              <td ng-hide="regra.geral">{{(regra.valor === null ? \'\' : regra.valor)}}</td>\n                              <td ng-show="regra.geral"><i class="text-secondary">Todas as ocorrências</i></td>\n                              <td class="alt-importacao-csv-rules-td-count-field">{{regra.quantidade}}</td>\n                              <td class="alt-importacao-csv-rules-td-select-field"\n                                style="min-width: 180px;"\n                                ng-class="{\'has-error\': !regra.objeto && campo.obrigatorio && importacaoCsvCtrl.exibirMensagemErro}">\n                                <select id="alt-importacao-csv-rules-select-{{campo.chave}}-{{$index}}"\n                                  class="alt-importacao-csv-rules-select form-control"\n                                  style="width: 100%;"\n                                  ng-model="regra.objeto"\n                                  ng-change="importacaoCsvCtrl.resumirRegrasDeValor()"\n                                  ng-options="{{importacaoCsvCtrl.ngOptionsRegraDeCampo(campo)}}">\n                                </select>\n                              </td>\n                              <td class="alt-importacao-csv-rules-td-actions-field">\n                                <button type="button" class="btn btn-default pull-right" \n                                  ng-disabled="!regra.objeto"\n                                  ng-click="importacaoCsvCtrl.limparRegra(campo, $index)">\n                                  Limpar\n                                </button>\n                              </td>\n                            </tr>\n                          </tbody>\n                        </table>\n                      </div>\n                    </div>\n\n                    <div class="row alt-espacamento-bottom">\n                      <div class="col-xs-12 alt-espacamento-bottom" ng-show="campo.obrigatorio && campo.resumoRegrasDeValor.nulosInvalidos > 0 && importacaoCsvCtrl.exibirMensagemErro">\n                        <span class="text-danger">É necessário vincular todos os registros de <b>{{campo.nome}}</b></span>\n                      </div>\n                    </div>\n\n                  </div>\n                </div>\n              </div>\n\n              <div class="row alt-espacamento-top">\n                <div class="col-xs-12 alt-espacamento-top" role="alert" ng-show="importacaoCsvCtrl.resumoRegrasDeValor.nulosInvalidos > 0 && importacaoCsvCtrl.exibirMensagemErro">\n                  <div class="alert alert-danger alert-dismissible">\n                    <button type="button" ng-click="importacaoCsvCtrl.removerMensagemErro()" class="close" aria-label="Close"><span aria-hidden="true">&times;</span></button>\n                    <span class="alt-importacao-csv-input-ckeck">\n                      <i class="fa fa-exclamation-triangle"></i> Configure todos os vinculos obrigatórios para importar o arquivo.\n                    </span>\n                  </div>\n                </div>\n              </div>\n\n            </div>\n          </div>\n\n          <div ng-show="importacaoCsvCtrl.steps[3].active"\n            class="alt-importacao-csv-wizard-step">\n            <div class="modal-body alt-importacao-modal-body-detalhes">\n              \n              <div class="row alt-importacao-csv-menu-detalhes">\n                <div class="col-md-4 bold">\n                  {{importacaoCsvCtrl.lote.nomeArquivo}}\n                </div>\n                <div class="col-md-4">\n                  <b alt-importacao-csv-contador count-to="importacaoCsvCtrl.lote.quantidadeRegistros" duration="1" count-from="0"></b> registros\n                </div>\n                <div class="col-md-4">\n                  <b>{{((importacaoCsvCtrl.lote.quantidadeProcessados/importacaoCsvCtrl.lote.quantidadeRegistros)*100).toFixed(0)}}%</b> processado\n                </div>\n              </div>\n\n              <div class="row">\n                <hr style="margin: 12px 0;"/>\n              </div>\n\n              <div class="row" ng-show="importacaoCsvCtrl.lote.quantidadeProcessados !== importacaoCsvCtrl.lote.quantidadeRegistros">\n                <div class="col-xs-12 alt-importacao-csv-progress-details" ng-show="importacaoCsvCtrl.lote.quantidadeProcessados != 0">\n                  <uib-progressbar class="progress-striped active" value="(importacaoCsvCtrl.lote.quantidadeProcessados/importacaoCsvCtrl.lote.quantidadeRegistros)*100" type="info">\n                    <b>{{((importacaoCsvCtrl.lote.quantidadeProcessados/importacaoCsvCtrl.lote.quantidadeRegistros)*100).toFixed(0)}}%</b>&nbsp; processando...\n                  </uib-progressbar>\n                </div>\n                <div class="col-xs-12 alt-importacao-csv-progress-details" ng-show="importacaoCsvCtrl.lote.quantidadeProcessados == 0">\n                  <uib-progressbar class="progress-striped active" value="15" type="info">\n                    processando...\n                  </uib-progressbar>\n                </div>\n              </div>\n\n              <div class="row alt-espacamento-bottom alt-importacao-registros-info">\n                <div class="col-md-4" ng-show="!!importacaoCsvCtrl.lote.quantidadeImportadosSucesso">\n                  <span class="alt-importacao-registros-numero text-success alt-espacamento-left" alt-importacao-csv-contador count-to="importacaoCsvCtrl.lote.quantidadeImportadosSucesso" duration="1" count-from="importacaoCsvCtrl.countFromImportadosSucesso"></span> registros importados\n                </div>\n                <div class="col-md-4" ng-show="!!importacaoCsvCtrl.lote.quantidadeImportadosAviso">\n                  <span class="alt-importacao-registros-numero text-warning" alt-importacao-csv-contador count-to="importacaoCsvCtrl.lote.quantidadeImportadosAviso" duration="1" count-from="importacaoCsvCtrl.countFromImportadosAviso"></span> importados com aviso\n                </div>\n                <div class="col-md-4" ng-show="!!importacaoCsvCtrl.lote.quantidadeErros">\n                  <span class="alt-importacao-registros-numero text-danger" alt-importacao-csv-contador count-to="importacaoCsvCtrl.lote.quantidadeErros" duration="1" count-from="importacaoCsvCtrl.countFromNaoImportados"></span> não importados\n                </div>\n              </div>\n\n              <div class="row alt-espacamento-top" ng-show="importacaoCsvCtrl.lote.status == 1">\n                <div class="col-md-12 alt-espacamento-left">\n                  <h3 class="text-muted"><i class="fa fa-thumbs-up thumbs-success alt-espacamento-right"></i> Todos os registros foram importados!</h3>\n                </div>\n              </div>\n\n              <div class="row alt-espacamento-top" ng-show="importacaoCsvCtrl.carregandoLogsItens">\n                <div class="col-md-12 alt-espacamento-left text-center">\n                  <br/><i class="text-muted fa fa-refresh fa-spin fa-3x fa-fw"></i>\n                </div>\n              </div>\n\n              <div class="row alt-espacamento-top" ng-show="importacaoCsvCtrl.lote.status == 2">\n                <div class="col-md-12">\n                  <ul class="nav nav-tabs row alt-importacao-nav-tabs alt-espacamento-top" role="tablist">\n                    <li class="alt-importacao-registros-conflito" role="presentation" ng-show="!!importacaoCsvCtrl.itensImportadosComAviso.length" ng-class="{\'active\': !importacaoCsvCtrl.itensNaoImportados.length}" koopon-comum-toggle-aba toggle="#koopon-importacao-importados-observacao" contexto="#alt-importacao-csv-modal">\n                      <a href="">Importados com aviso ({{importacaoCsvCtrl.lote.quantidadeImportadosAviso}})</a>\n                    </li>\n                    <li class="alt-importacao-registros-erro" role="presentation" ng-show="!!importacaoCsvCtrl.itensNaoImportados.length" ng-class="{\'active\': !!importacaoCsvCtrl.itensNaoImportados.length}" koopon-comum-toggle-aba toggle="#koopon-importacao-nao-importados" contexto="#alt-importacao-csv-modal">\n                      <a href="">Registros não importados ({{importacaoCsvCtrl.lote.quantidadeErros}})</a>\n                    </li>\n                  </ul>\n                </div>\n              </div>\n\n              <div class="row alt-importacao-tab-scroll">\n\n                <div class="col-md-12 alt-espacamento-top alt-espacamento-bottom">\n                  <div class="tab-content alt-espacamento-top alt-espacamento-bottom" ng-show="importacaoCsvCtrl.lote.status == 2">\n                    <div role="tabpanel" class="tab-pane" ng-class="{\'active\': !!importacaoCsvCtrl.itensNaoImportados.length}" id="koopon-importacao-nao-importados">\n\n                      <div class="">\n                        <div class="" ng-repeat="item in importacaoCsvCtrl.itensNaoImportados">\n\n                          <div class="alt-importacao-csv-report row-{{ $index % 2 === 0 ? \'par\' : \'impar\' }}">\n                            <div class="alt-importacao-csv-report-row-body">\n                              <div class="row hidden-xs hidden-sm" ng-if="$first">\n                                <div ng-repeat="campo in importacaoCsvCtrl.camposOrdenados" class="col-md-{{ campo.template.width }} alt-importacao-csv-report-title">{{ campo.nome }}</div>\n                                <div class="col-md-1 alt-importacao-csv-report-title text-center">Status</div>\n                                <div class="col-md-1 alt-importacao-csv-report-title">&nbsp;</div>\n                              </div>\n\n                              <div class="row">\n                                <div ng-repeat="campo in importacaoCsvCtrl.camposOrdenados" class="col-md-{{ campo.template.width }} alt-importacao-csv-report-row" title="{{ importacaoCsvCtrl.obterPropriedadeTemplate(item.objeto, campo) }}">\n                                  <span class="text-muted visible-xs-inline-block visible-sm-inline-block">{{ campo.nome }}:</span> <span ng-bind="importacaoCsvCtrl.obterPropriedadeTemplate(item.objeto, campo) | LimitadorTexto:campo.template.textLimit"></span>\n                                </div>\n                                <div class="col-xs-9 col-sm-9 col-md-1 alt-importacao-csv-report-row alt-importacao-csv-report-row-status" ng-switch="item.status">\n                                  <span class="text-muted visible-xs-inline-block visible-sm-inline-block">Status:</span> \n                                  <i ng-switch-default class="fa fa-clock-o" aria-hidden="true"></i>\n                                  <i ng-switch-when="1" class="fa fa-check-circle text-success" aria-hidden="true"></i>\n                                  <i ng-switch-when="2" class="fa fa-times-circle text-danger" aria-hidden="true"></i>\n                                  <i ng-switch-when="3" class="fa fa-exclamation-triangle text-warning" aria-hidden="true"></i>\n                                  <span ng-switch-when="2" class="visible-xs-inline-block visible-sm-inline-block"> não importado</span>\n                                  <span ng-switch-when="3" class="visible-xs-inline-block visible-sm-inline-block"> importado com observação</span>\n                                </div>\n                                <div class="col-xs-3 col-sm-3 col-md-1 alt-importacao-csv-report-row" ng-init="item.collapse = true">\n                                  <button class="btn btn-sm btn-default pull-right alt-importacao-csv-report-row-button" ng-click="item.collapse = !item.collapse">\n                                    <i ng-class="{\'fa fa-angle-down\': item.collapse, \'fa fa-angle-up\': !item.collapse }"></i>\n                                  </button>\n                                </div>\n                              </div>\n\n                              <div ng-show="!item.collapse" class="alt-importacao-csv-report-row-detalhes">\n\n                                <div class="row">\n                                  <div class="alt-importacao-csv-report-row-head">\n                                    <div class="alt-importacao-csv-report-row-head-title">Linha {{item.linha}}</div>\n                                    <div class="alert alert-sm alert-danger" ng-bind-html="importacaoCsvCtrl.obterMensagemErro(item.mensagemErro)"></div>\n                                  </div>\n                                </div>\n\n                                <div class="row">\n                                  <div class="col-sm-6" ng-repeat="campo in importacaoCsvCtrl.campos" >\n                                    <strong>{{ campo.nome }}:</strong> <span>{{ importacaoCsvCtrl.obterPropriedadeTemplate(item.objeto, campo) }}</span>\n                                  </div>\n                                </div>\n                              </div>\n                            </div>\n\n                          </div>\n                        </div>\n                        <div class="ng-scope">\n                          <div class="alt-importacao-detalhes-itens-footer">\n                            <span ng-show="importacaoCsvCtrl.itensNaoImportados.length > 0 && importacaoCsvCtrl.itensNaoImportados.length === importacaoCsvCtrl.itensNaoImportados[0].qtdItens">\n                              Exibindo todos os {{importacaoCsvCtrl.itensNaoImportados.length}} itens\n                            </span>\n                            <span ng-hide="importacaoCsvCtrl.itensNaoImportados.length > 0 && importacaoCsvCtrl.itensNaoImportados.length === importacaoCsvCtrl.itensNaoImportados[0].qtdItens">\n                              Exibindo {{importacaoCsvCtrl.itensNaoImportados.length}} de\n                              {{importacaoCsvCtrl.itensNaoImportados.length > 0 ? importacaoCsvCtrl.itensNaoImportados[0].qtdItens : 0}}\n                            </span>\n                          </div>\n                        </div>\n                      </div>\n                      <div class="alt-espacamento-top">\n                        <koopon-comum-mais-resultados\n                          visivel="importacaoCsvCtrl.itensNaoImportados.length > 0 && importacaoCsvCtrl.itensNaoImportados[0].qtdItens > importacaoCsvCtrl.itensNaoImportados.length"\n                          busca="importacaoCsvCtrl.obterMaisItensNaoImportados()">\n                        </koopon-comum-mais-resultados>\n                      </div>\n                    </div>\n\n                    <div role="tabpanel" class="tab-pane" ng-class="{\'active\': !importacaoCsvCtrl.itensNaoImportados.length}" id="koopon-importacao-importados-observacao">\n\n                      <div>\n                        <div class="" ng-repeat="item in importacaoCsvCtrl.itensImportadosComAviso">\n\n                          <div class="alt-importacao-csv-report row-{{ $index % 2 === 0 ? \'par\' : \'impar\' }}">\n                            <div class="alt-importacao-csv-report-row-body">\n                              <div class="row hidden-xs hidden-sm" ng-if="$first">\n                                <div ng-repeat="campo in importacaoCsvCtrl.camposOrdenados" class="col-md-{{ campo.template.width }} alt-importacao-csv-report-title">{{ campo.nome }}</div>\n                                <div class="col-md-1 alt-importacao-csv-report-title text-center">Status</div>\n                                <div class="col-md-1 alt-importacao-csv-report-title">&nbsp;</div>\n                              </div>\n\n                              <div class="row">\n                                <div ng-repeat="campo in importacaoCsvCtrl.camposOrdenados" class="col-md-{{ campo.template.width }} alt-importacao-csv-report-row" title="{{ importacaoCsvCtrl.obterPropriedadeTemplate(item.objeto, campo) }}">\n                                  <span class="small text-muted visible-xs-inline-block visible-sm-inline-block">{{ campo.nome }}:</span>  <span ng-bind="importacaoCsvCtrl.obterPropriedadeTemplate(item.objeto, campo) | LimitadorTexto:campo.template.textLimit"></span>\n                                </div>\n                                <div class="col-xs-9 col-sm-9 col-md-1 alt-importacao-csv-report-row alt-importacao-csv-report-row-status" ng-switch="item.status">\n                                  <span class="small text-muted visible-xs-inline-block visible-sm-inline-block">Status:</span> \n                                  <i ng-switch-default class="fa fa-clock-o" aria-hidden="true"></i>\n                                  <i ng-switch-when="1" class="fa fa-check-circle text-success" aria-hidden="true"></i>\n                                  <i ng-switch-when="2" class="fa fa-times-circle text-danger" aria-hidden="true"></i>\n                                  <i ng-switch-when="3" class="fa fa-exclamation-triangle text-warning" aria-hidden="true"></i>\n                                  <span ng-switch-when="2" class="visible-xs-inline-block visible-sm-inline-block"> não importado</span>\n                                  <span ng-switch-when="3" class="visible-xs-inline-block visible-sm-inline-block"> importado com observação</span>\n                                </div>\n                                <div class="col-xs-3 col-sm-3 col-md-1 alt-importacao-csv-report-row" ng-init="item.collapse = true">\n                                  <button class="btn btn-sm btn-default pull-right alt-importacao-csv-report-row-button" ng-click="item.collapse = !item.collapse">\n                                    <i ng-class="{\'fa fa-angle-down\': item.collapse, \'fa fa-angle-up\': !item.collapse }"></i>\n                                  </button>\n                                </div>\n                              </div>\n\n                              <div ng-show="!item.collapse" class="alt-importacao-csv-report-row-detalhes">\n\n                                <div class="row">\n                                  <div class="alt-importacao-csv-report-row-head">\n                                    <div class="alt-importacao-csv-report-row-head-title">Registro {{item.linha}}</div>\n                                    <div class="alert alert-sm alert-warning" ng-bind-html="importacaoCsvCtrl.obterMensagemErro(item.mensagemErro)"></div>\n                                  </div>\n                                </div>\n\n                                <div class="row">\n                                  <div class="col-sm-6" ng-repeat="campo in importacaoCsvCtrl.campos" >\n                                    <strong>{{ campo.nome }}:</strong> <span>{{ importacaoCsvCtrl.obterPropriedadeTemplate(item.objeto, campo) }}</span>\n                                  </div>\n                                </div>\n                              </div>\n\n                            </div>\n                          </div>\n                        </div>\n                        <div class="ng-scope">\n                          <div class="alt-importacao-detalhes-itens-footer">\n                            <span ng-show="importacaoCsvCtrl.itensImportadosComAviso.length > 0 && importacaoCsvCtrl.itensImportadosComAviso.length === importacaoCsvCtrl.itensImportadosComAviso[0].qtdItens">\n                              Exibindo todos os {{importacaoCsvCtrl.itensImportadosComAviso.length}} itens\n                            </span>\n                            <span ng-hide="importacaoCsvCtrl.itensImportadosComAviso.length > 0 && importacaoCsvCtrl.itensImportadosComAviso.length === importacaoCsvCtrl.itensImportadosComAviso[0].qtdItens">\n                              Exibindo {{importacaoCsvCtrl.itensImportadosComAviso.length}} de\n                              {{importacaoCsvCtrl.itensImportadosComAviso.length > 0 ? importacaoCsvCtrl.itensImportadosComAviso[0].qtdItens : 0}}\n                            </span>\n                          </div>\n                        </div>\n                      </div>\n                      <div class="alt-espacamento-top">\n                        <koopon-comum-mais-resultados\n                          visivel="importacaoCsvCtrl.itensImportadosComAviso.length > 0 && importacaoCsvCtrl.itensImportadosComAviso[0].qtdItens > importacaoCsvCtrl.itensImportadosComAviso.length"\n                          busca="importacaoCsvCtrl.obterMaisItensImportadosComAviso()">\n                        </koopon-comum-mais-resultados>\n                      </div>\n\n                    </div>\n                  </div>\n                </div>\n\n              </div>\n\n            </div>\n          </div>\n        </div>\n        <div class="modal-footer" ng-hide="importacaoCsvCtrl.visualizacao">\n          <button type="button" class="btn btn-default pull-left" \n            ng-click="importacaoCsvCtrl.prevStep()"\n            ng-hide="importacaoCsvCtrl.steps[0].active">\n            <i class="fa fa-long-arrow-left"></i> Anterior\n          </button>\n\n          <button type="button" class="btn btn-primary"\n            ng-show="importacaoCsvCtrl.steps[0].active || (importacaoCsvCtrl.exibeEtapaRegras && importacaoCsvCtrl.steps[1].active)"\n            ng-click="importacaoCsvCtrl.invalidStep(importacaoCsvCtrl.nextStep)">\n            Próximo &nbsp;<i class="fa fa-long-arrow-right"></i>\n          </button>\n\n          <button type="button" class="btn btn-primary"\n            ng-hide="importacaoCsvCtrl.steps[0].active || (importacaoCsvCtrl.exibeEtapaRegras && importacaoCsvCtrl.steps[1].active)"\n            ng-click="importacaoCsvCtrl.invalidStep(importacaoCsvCtrl.salvarImportacao)">\n            Importar\n          </button>\n\n          <button type="button" class="btn btn-default" ng-click="importacaoCsvCtrl.limparImportacao()">Cancelar</button>\n        </div>\n        <div class="modal-footer" ng-show="importacaoCsvCtrl.visualizacao">\n          <button type="button" class="btn btn-default" ng-click="importacaoCsvCtrl.limparImportacao()">Fechar</button>\n        </div>\n      </div>\n    </div>\n  </div>',
scope:{},controller:["$rootScope","$scope","$sce","$q","$timeout","AltModalService","AltSelectService","AltAlertaFlutuanteService","AltImportacaoCsvCampoModel","AltImportacaoCsvLoteModel","AltImportacaoCsvModel","AltImportacaoCsvEvento","AltImportacaoCsvOpcoesTituloMensagemModel","AltCarregandoInfoService","moment",function(a,t,e,s,i,r,n,l,c,p,m,d,v,u,g){var h=this,C="#alt-importacao-csv-modal",b="#alt-importacao-csv-rules-select",f="#alt-importacao-csv-btn-group-rules",w=".alt-importacao-csv-select-field";h.itensNaoImportados=[],h.itensImportadosComAviso=[];var I=function(o,a){var t=$(o).find('input[type="radio"]');t.removeAttr("checked"),t.parent("label").removeClass("active"),$(t[a]).attr("checked","checked"),$(t[a]).parent("label").addClass("active")},x=function(){h.importacao?(h.arquivo.colunas.map(function(o,a){h.importacao.colunas[a].nome=o}),h.arquivoAnterior=o.copy(h.arquivo)):(h.importacao=new m(h.campos),h.arquivo.colunas.map(function(o,a){h.importacao.adicionarColuna(o,a)})),h.importacao.validarMapa(),n.inicializar(w),i(function(){$(".alt-importacao-csv-planilha-mapeamento")[0].scrollLeft=0})},A=function(){h.resumoRegrasDeValor=h.importacao.aplicarRegrasDeValor(h.arquivo.linhas),h.importacao.campos.forEach(function(o){o.tipo===Object&&o.regrasDeValor.forEach(function(a,t){var e=b+"-"+o.chave+"-"+t;o.objetoCriarNovo?h.inicializarComboComOpcaoCriarNovo(e,o.chave,t):n.inicializar(e)})}),h.resumoRegrasDeValor.exibir="todos",I(f,0)},q=function(){0<h.lote.quantidadeErros?$(".alt-importacao-registros-erro a").click():0<h.lote.quantidadeImportadosAviso&&$(".alt-importacao-registros-conflito a").click()},y=function(o){h.visualizacao=!0,h.steps[0].active=!1,h.steps[3].active=!0,h.itensNaoImportados=[],h.itensImportadosComObservacao=[],h.lote=new p(o.loteProcessado),h.obterItensNaoImportados=o.obterItensNaoImportados,h.obterItensImportadosComAviso=o.obterItensImportadosComAviso,h.carregandoLogsItens=!0,s.all([h.obterItensNaoImportados(h.lote.idLoteImportacao),h.obterItensImportadosComAviso(h.lote.idLoteImportacao)]).then(function(o){h.itensNaoImportados=o[0],h.itensImportadosComAviso=o[1],q()})["finally"](function(){return h.carregandoLogsItens=!1})},k=function(o){h.lote&&(0==o.loteProcessado.status?(h.countFromImportadosSucesso=h.lote.quantidadeImportadosSucesso,h.countFromImportadosAviso=h.lote.quantidadeImportadosAviso,h.countFromNaoImportados=h.lote.quantidadeErros,h.lote.quantidadeImportadosSucesso=o.loteProcessado.quantidadeImportadosSucesso,h.lote.quantidadeImportadosAviso=o.loteProcessado.quantidadeImportadosAviso,h.lote.quantidadeErros=o.loteProcessado.quantidadeErros,h.lote.quantidadeProcessados=o.loteProcessado.quantidadeProcessados,h.lote.status=o.loteProcessado.status):y(o))},M=function(a){h.labelTipo=a.labelTipo,h.labelTipoSingular=a.labelTipoSingular,h.validarLote=a.validarLote,h.gravarLote=a.gravarLote,h.eventoCriacao=a.eventoCriacao,h.campos=o.copy(a.campos),h.camposConfigurados=o.copy(a.campos),h.arquivoAnterior=null,h.arquivo=null,h.arquivoOpcoes={colunasPossuemTitulos:!1},h.colunasSelecao=null,h.lote=null,h.visualizacao=!1,h.importacao=void 0,h.resumoRegrasDeValor=void 0,h.itensNaoImportados=[],h.itensImportadosComObservacao=[],h.exibirMensagemErro=!1,h.countFromImportadosSucesso=0,h.countFromImportadosAviso=0,h.countFromNaoImportados=0,h.exibeEtapaRegras=0!==_.filter(h.camposConfigurados,{tipo:Object}).length;var t=null,s=null,i=null;!!a.titulosMensagensCustomizadas&&a.titulosMensagensCustomizadas.length&&(t=a.obterTitulosMensagensPorStep(1),s=a.obterTitulosMensagensPorStep(2),i=a.obterTitulosMensagensPorStep(3)),h.steps=[{name:"Passo 1",number:1,active:!0,progress:h.exibeEtapaRegras?16.65:25,init:null,title:t?t.title:"Importar dados",message:t?e.trustAsHtml(t.message):e.trustAsHtml("Selecione o arquivo para importação com extensão xls, xlsx, ods ou csv")},{name:"Passo 2",number:2,active:!1,progress:h.exibeEtapaRegras?49.95:75,init:x,title:s?s.title:"Configurar importação",message:s?e.trustAsHtml(s.message):e.trustAsHtml("Selecione o(s) campo(s) do ERP4ME correspondente(s) a cada coluna do arquivo para realizar a importação")},{name:"Passo 3",number:3,active:!1,progress:h.exibeEtapaRegras?83.28:100,init:A,title:i?i.title:"Configurar vínculos",message:i?e.trustAsHtml(i.message):e.trustAsHtml("Vincule a informação do arquivo ao <em>Campo</em> correspondente no cadastro do ERP4ME"),menuHidden:!h.exibeEtapaRegras},{name:"Visualização",number:4,active:!1,progress:100,init:null,title:"",message:e.trustAsHtml(""),menuHidden:!0}],h.progress=h.steps[0].progress,h.camposOrdenados=h.gerarCamposOrdenadosListaVisualizacao(a.campos),!a.visualizacao||y(a)};h.obterMaisItensNaoImportados=function(){return h.obterItensNaoImportados(h.lote.idLoteImportacao,!0).then(function(o){o.forEach(function(o){h.itensNaoImportados.push(o)})})},h.obterMaisItensImportadosComAviso=function(){return h.obterItensImportadosComAviso(h.lote.idLoteImportacao,!0).then(function(o){o.forEach(function(o){h.itensImportadosComAviso.push(o)})})},h.getTitle=function(){var o=_.find(h.steps,function(o){return!0===o.active});return o?o.title:""},h.getMessage=function(){var o=_.find(h.steps,function(o){return!0===o.active});return o?o.message:""},h.nextStep=function(){h.removerMensagemErro(),u.exibe(),i(function(){var o=_.findIndex(h.steps,{active:!0}),a=h.steps[o],t=h.steps[o+1];a.active=!1,a.completed=!0,t.active=!0,h.progress=t.progress,t.init(),u.esconde()},200)},h.prevStep=function(){h.removerMensagemErro();var o=_.findIndex(h.steps,{active:!0});h.steps[o].active=!1,h.steps[o].completed=!1,h.steps[o-1].active=!0,h.progress=h.steps[o-1].progress},h.reloadStep=function(o){var a=h.steps[o];!a||!a.init||a.init()},h.invalidStep=function(o){var a=_.findIndex(h.steps,{active:!0}),t=!1;return 0===a?t=!h.arquivo||!h.arquivo.valido:1===a?t=h.importacao.mapaInvalido:2===a?t=0<h.resumoRegrasDeValor.nulosInvalidos:3===a?t=h.lote&&0!==h.lote.erros:void 0,t?(h.exibirMensagemErro=!0,t):(o(),t)},h.vincular=function(o,a){h.importacao.vincular(o,a),n.inicializar(w)},h.desvincular=function(o){h.importacao.validarMapa(),h.importacao.desvincular(o),n.inicializar(w)},h.campoNaoMapeado=function(a){return o.isUndefined(a.coluna)},h.resumirRegrasDeValor=function(){h.removerMensagemErro(),o.extend(h.resumoRegrasDeValor,h.importacao.resumirRegrasDeValor()),"nulosValidos"===h.resumoRegrasDeValor.exibir&&0===h.resumoRegrasDeValor.nulosValidos&&(h.resumoRegrasDeValor.exibir="todos",I(f,0)),"nulosInvalidos"===h.resumoRegrasDeValor.exibir&&0===h.resumoRegrasDeValor.nulosInvalidos&&(h.resumoRegrasDeValor.exibir="todos",I(f,0))},h.permiteAlteracaoArquivo=function(){var o=_.findIndex(h.steps,{active:!0});return 2===o||3===o},h.arquivoAlterado=function(){h.removerMensagemErro();var a=_.findIndex(h.steps,{active:!0}),t=0===a;return!h.arquivoAnterior||h.arquivoAnterior.nome===h.arquivo.nome||t?(!h.arquivoAnterior||h.arquivoAnterior.nome===h.arquivo.nome||(h.importacao=void 0),t&&!!h.arquivoAnterior&&h.arquivoAnterior.nome!==h.arquivo.nome&&(h.campos=o.copy(h.camposConfigurados)),1===a?void x():(2===a&&h.campos.forEach(function(o){o.regrasDeValor=void 0}),3===a&&(h.lote=void 0),h.arquivoAnterior=o.copy(h.arquivo),void h.reloadStep(a))):(h.arquivo=o.copy(h.arquivoAnterior),l.exibe({msg:"O nome do documento deve coincidir com o do arquivo da importação."}))},h.criarNovoObjetoDeRegra=function(o,a){r.close(C),i(function(){var e=_.find(h.importacao.campos,{chave:o});!e.objetoCriarNovo||!e.objetoCriarNovo.funcao||(e.objetoCriarNovo.funcao(),e.atribuirNovoARegra=a,t.$on(e.objetoCriarNovo.eventoAtualizacao,function(o,a){void 0!==e.atribuirNovoARegra&&(r.open(C),i(function(){e.regrasDeValor[e.atribuirNovoARegra].objeto=a;var o=b+"-"+e.chave+"-"+e.atribuirNovoARegra;h.inicializarComboComOpcaoCriarNovo(o,e.chave,e.atribuirNovoARegra),e.atribuirNovoARegra=void 0,h.resumirRegrasDeValor()},200))}))},200)},h.limparRegra=function(o,a){var t=o.regrasDeValor[a];t.objeto=void 0;var e=b+"-"+o.chave+"-"+a;o.objetoCriarNovo?h.inicializarComboComOpcaoCriarNovo(e,o.chave,a):n.inicializar(e),h.resumirRegrasDeValor()},h.inicializarComboComOpcaoCriarNovo=function(o,a,e){i(function(){n.inicializarComOpcaoCriarNovo(o,{escopo:t,strMetodo:"importacaoCsvCtrl.criarNovoObjetoDeRegra('"+a+"', "+e+")"},{})})},h.salvarImportacao=function(){u.exibe(),i(function(){var t=h.importacao.montarLote(h.arquivo.linhas,h.arquivo.nome,h.lote);h.validarLote(t).then(function(t){h.lote=t,h.lote.exibir="todos";var e=o.copy(h.lote);return h.gravarLote(e).then(function(o){h.limparImportacao(),a.$broadcast(h.eventoCriacao,o)})["catch"](function(o){o&&o.data&&o.data.informacaoDuplicada&&h.limparImportacao()}),!0})},200)},h.editarObjeto=function(o){"function"==typeof o.editar&&(r.close(C),o.editar(o.idObjeto,o.objeto),t.$on(o.eventoEdicaoConcluida,function(){r.open(C)}))},h.nomeColuna=function(o){var a=_.find(h.importacao.colunas,{numero:o});return a?a.nome:""},h.ngOptionsRegraDeCampo=function(o){var a="",t="";return!o.objetoOpcoesListagem.groupBy||(a="group by obj[campo.objetoOpcoesListagem.groupBy] "),!!o.objetoOpcoesListagem.orderBy&&$.isArray(o.objetoOpcoesListagem.orderBy)&&(t="| orderBy:["+_.map(o.objetoOpcoesListagem.orderBy,function(o){return"'"+o+"'"}).toString()+"]"),"obj as obj[campo.objetoReferencia] "+a+" for obj in campo.objetoListagem() "+t+" track by obj[campo.objetoChave]"},h.obterQtdCamposRegras=function(o){return o.filter(function(o){return"Object"===o.tipo.name}).length},h.gerarCamposOrdenadosListaVisualizacao=function(o){var a=o.filter(function(o){return void 0!==o.template.column});return _.sortBy(a,"template.column")},h.obterPropriedadeTemplate=function(o,a){if("undefined"==typeof o||!a||!a.template||!a.template.property)return!1;if("function"==typeof a.template.property)return a.template.property(o);var t=a.template.property.indexOf(".");if(-1<t){var e=angular.copy(a);return e.property=a.template.property.substr(t+1),h.obterPropriedadeTemplate(o[a.template.property.substring(0,t)],e)}if(a.tipo===Date){var s=o[a.template.property],i=g(s);return i.isValid()?i.format("DD/MM/YYYY"):s}return o[a.template.property]},h.obterMensagemErro=function(o){return e.trustAsHtml(o)},h.formatarLinhaValor=function(o){if(o instanceof Date){var a=g(o).add(1,"days").format("DD/MM/YYYY");return a}return o},h.removerMensagemErro=function(){h.exibirMensagemErro=!1},h.atualizarMensagensErro,h.limparImportacao=function(){h.arquivo=null,h.arquivoAnterior=null,h.lote=null,h.arquivoOpcoes.colunasPossuemTitulos=void 0,o.element(".alt-importacao-csv-wrapper .anexos-input-file-real").val(""),o.element(".alt-importacao-csv-wrapper .anexos-input-file-real")[0]=null,r.close(C)},t.$on(d.modal.ABRE_MODAL_IMPORTACAO_ESPECIFICA,function(o,a){M(a),r.open(C)}),t.$on(d.processamento.ATUALIZAR_LOTE,function(o,a){k(a)})}],controllerAs:"importacaoCsvCtrl"}}])}(angular),function(o){o.module("alt.importacao-csv").directive("altImportacaoCsvLeitor",["XLS","XLSX","AltCarregandoInfoService",function(a,t,e){return{require:"ngModel",scope:{opts:"="},link:function(s,i,r,n){function l(o,t){var e={};return o.SheetNames.forEach(function(s){var i=a.utils.sheet_to_row_object_array(o.Sheets[s],t);0<i.length&&(e[s]=i)}),e}function c(o){return o.substring(o.lastIndexOf(".")+1,o.length).toLowerCase()}function p(o){return!("xls"!==o&&"xlsx"!==o&&"csv"!==o&&"ods"!==o)}function m(o){var a=[];if(!o)return a;var e,i=t.utils.decode_range(o["!ref"]),r=i.s.r;for(e=i.s.c;e<=i.e.c;++e){var n="";if(s.opts&&s.opts.colunasPossuemTitulos){var l=o[t.utils.encode_cell({c:e,r:r})];l&&l.t&&(n=t.utils.format_cell(l))}else n="coluna "+(e+1);a.push(n)}return a}function d(o,a){var t={raw:!0};!s.opts||s.opts.colunasPossuemTitulos||!a||!a.length||(t.header=a);var e=l(o,t);return e[Object.keys(e)[0]]}function v(a){var r=new FileReader;e.exibe(),r.onload=function(r){var l=void 0,v=void 0,b=[],f=[];s.path=s.path?s.path:o.element(i[0]).val();var w=s.path?s.path.split("\\")[2]:"",I=c(w),x=a.size,A=!0,q="";p(I)?x>u?(A=!1,q="Selecione um arquivo válido, o tamanho máximo de arquivo permitido é de "+g):(l=r.target.result,v=t.read(l,{type:"binary",cellDates:!0}),b=m(v.Sheets[v.SheetNames[0]]),f=d(v,b)):(A=!1,q="Selecione um arquivo válido, tipos permitidos: XLS, XLSX, CSV e ODS"),f.length>h&&(A=!1,q="Selecione um arquivo válido, a quantidade máxima permitida para importação é de "+C+" registros"),s.dadosArquivo={colunas:b,linhas:f,dezPrimeirasLinhas:f.slice(0,10),nome:w,extensao:I,valido:A,mensagem:q},s.$apply(function(){n.$setViewValue(s.dadosArquivo),n.$render(),o.element(i).val(""),e.esconde()})},r.readAsBinaryString(a)}var u=2097152,g="2MB",h=3e3,C="3.000";s.dadosArquivo=null,s.file=null,s.path=null,i.on("change",function(o){e.exibe(),s.dadosArquivo=null,s.file=null,s.path=null,s.file=o.target.files[0],v(s.file)}),s.$watch("opts.colunasPossuemTitulos",function(a,t){s.dadosArquivo?(a||t)&&void 0!==a&&s.file?v(s.file):(s.dadosArquivo=void 0,o.element(i).val("")):(o.element(i).val(""),s.file=null)})}}}])}(angular),function(o){o.module("alt.importacao-csv").factory("AltImportacaoCsvCampoModel",["$sce","$filter","$log","moment","latinize",function(a,t,e,s,i){var r=function(){function r(a){_classCallCheck(this,r),this.nome="",this.chave="",this.obrigatorio=!1,this.dado="",this.coluna=void 0,this.valor=void 0,this.referencia=void 0,this.valido=!1,this.tipo=void 0,this.vinculoRequisitado=!1,this.template={},this.objetoChave=void 0,this.objetoListagem=void 0,this.objetoReferencia=void 0,this.objetoAutoVinculo=void 0,this.objetoCriarNovo=void 0,this.objetoOpcoesListagem={},this.mensagens=[],o.extend(this,a),this._parseObrigatorio(),this._parseObjetoAutoVinculo(),this._parseTipo(),this._parseTemplate(),this._validarOpcoes()}return _createClass(r,[{key:"_validarOpcoes",value:function(){if(!this.nome)throw new Error('Parametro "nome" é obrigatório.');if(!this.chave)throw new Error('Parametro "chave" é obrigatório.');if(this.tipo===Object&&!this.objetoChave)throw new Error('Parametro "objetoChave" é obrigatório para campo Object.');if(this.tipo===Object&&!this.objetoReferencia)throw new Error('Parametro "objetoReferencia" é obrigatório para campo Object.');if(this.tipo===Object&&!this.objetoListagem)throw new Error('Parametro "objetoListagem" é obrigatório para campo Object.')}},{key:"_parseObrigatorio",value:function(){this.obrigatorio=!!this.obrigatorio}},{key:"_parseObjetoAutoVinculo",value:function(){var o=this;this.tipo!==Object||this.objetoAutoVinculo&&"function"==typeof this.objetoAutoVinculo||(this.objetoAutoVinculo=function(a){var t;return a&&(a=i(a.toLowerCase()),o.objetoListagem().forEach(function(e){if(i(e[o.objetoReferencia]).toLowerCase()===a)return void(t=e)})),t})}},{key:"_parseTipo",value:function(){this.tipo!==Object&&this.tipo!==Date&&this.tipo!==Boolean&&this.tipo!==Number&&(this.tipo=String)}},{key:"_parseTemplate",value:function(){this.template={width:"number"==typeof this.template.width?this.template.width:12,label:this.template.label?this.template.label:this.nome,textLimit:this.template.textLimit?this.template.textLimit:53,property:this.template.property?this.template.property:this.chave,column:this.template.column?parseInt(this.template.column):void 0}}},{key:"_incluirMensagemValidacao",value:function(o){this.mensagens.push({textoHtml:a.trustAsHtml("O campo <u>"+this.template.label+"</u> "+o+".")})}},{key:"_validarObjeto",value:function(){if(this.regrasDeValor&&0<this.regrasDeValor.length){var o=_.find(this.regrasDeValor,{valor:this.dado});if(o&&o.objeto)this.valor=o.objeto,this.referencia=o.objeto[this.objetoReferencia];else{var a=_.find(this.regrasDeValor,{geral:!0});if(a&&a.objeto)this.valor=a.objeto,this.referencia=a.objeto[this.objetoReferencia];else{var t=this.obrigatorio?"é obrigatório":"não possui regra";this._incluirMensagemValidacao(t),e.error(t)}}}}},{key:"_validarData",value:function(){var o=this.dado;if(0==this.dado instanceof Date&&(o=s(this.dado,["DD/MM/YYYY","DD-MM-YYYY","DD.MM.YYYY","YYYY/MM/DD","YYYY-MM-DD","YYYY.MM.DD","DD/MM/YY","DD-MM-YY","DD.MM.YY"])),s(o).isValid())this.valor=s(o).utc().format("YYYY-MM-DD"),this.referencia=this.dado;else{this.valor=void 0===this.dado?"":this.dado,this.referencia=this.valor;var a="não é uma data válida";this._incluirMensagemValidacao(a),e.error(a)}}},{key:"_validarTexto",value:function(){if(this.tipo===String&&"string"!=typeof this.dado&&(this.dado=this.dado.toString()),"string"==typeof this.dado&&255>=this.dado.length)this.valor=this.dado,this.referencia=this.valor;else{var o="não é um texto válido";this._incluirMensagemValidacao(o),e.error(o)}}},{key:"_validarNumero",value:function(){if(this.dado=this.dado.toString().replace(",","."),$.isNumeric(this.dado))this.valor=parseFloat(this.dado),this.referencia=this.monetario?t("currency")(this.valor,"R$ "):this.valor;else{var o="não é um número válido";this._incluirMensagemValidacao(o),e.error(o)}}},{key:"_validarBoleano",value:function(){var o=i(this.dado.toString().toLowerCase());if("0"===o||"false"===o||"nao"===o||"n"===o||"f"===o)this.valor=!1,this.referencia="Não";else if("1"===o||"true"===o||"sim"===o||"s"===o||"v"===o)this.valor=!0,this.referencia="Sim";else{var a='não é um "verdadeiro ou falso" válido';this._incluirMensagemValidacao(a),e.error(a)}}},{key:"validar",value:function(){switch(this.valor=void 0,this.referencia=void 0,this.mensagens=[],void 0===this.dado&&(this.dado=""),this.tipo){case Object:this._validarObjeto();break;case Date:this._validarData();break;case String:this._validarTexto();break;case Number:this._validarNumero();break;case Boolean:this._validarBoleano()}this.valido=void 0!==this.valor}},{key:"possuiRegraGeral",value:function(){var o=_.find(this.regrasDeValor,{geral:!0});return!!o&&!!o.objeto}},{key:"possuiVinculoOuRegraGeral",value:function(){return!!this.coluna||this.possuiRegraGeral()}}]),r}();return r}])}(angular),function(o){o.module("alt.importacao-csv").factory("AltImportacaoCsvItemModel",["AltImportacaoCsvResumoItemModel",function(o){return function a(t){_classCallCheck(this,a),this.objeto={},this.resumo=new o(t),this.desconsiderado=!1,this.possuiErro=!1,this.possuiConflito=!1}}])}(angular),function(o){o.module("alt.importacao-csv").factory("AltImportacaoCsvLoteModel",[function(){var a=function(){function a(t){_classCallCheck(this,a),this.itens=[],this.processando=0,this.validos=0,this.erros=0,this.conflitos=0,this.nomeArquivo="",this.quantidadeImportadosSucesso=0,this.quantidadeImportadosAviso=0,this.quantidadeErros=0,o.extend(this,t)}return _createClass(a,[{key:"resumir",value:function(){var o=this;this.processando=0,this.validos=0,this.erros=0,this.conflitos=0,this.itens.forEach(function(a){3===a.status?o.conflitos++:2===a.status?o.erros++:1===a.status?o.validos++:o.processando++})}}]),a}();return a}])}(angular),function(o){o.module("alt.importacao-csv").factory("AltImportacaoCsvModel",["$sce","$q","AltImportacaoCsvItemModel","AltImportacaoCsvLoteModel","_",function(a,t,e,s,i){var r=function(){function a(o){_classCallCheck(this,a),this.campos=o,this.colunas=[],this.mapaInvalido=!1}return _createClass(a,[{key:"validarMapa",value:function(){var o=this;this.mapaInvalido=!1,this.campos.forEach(function(a){a.tipo===Object||(a.obrigatorio&&!a.coluna?(a.vinculoRequisitado=!0,o.mapaInvalido=!0):a.vinculoRequisitado=!1)})}},{key:"adicionarColuna",value:function(o,a){this.colunas.push({nome:o,numero:a+1,titulo:"Coluna "+(a+1)+" – "+o,campos:[]})}},{key:"vincular",value:function(o,a){var t=i.find(this.campos,{chave:o}),e=i.find(this.colunas,{numero:a});!t||!e||(t.coluna=a,e.campos.push(t),this.validarMapa())}},{key:"desvincular",value:function(o){var a=i.find(this.campos,{chave:o}),t=i.find(this.colunas,{numero:a.coluna});!a||!t||(i.remove(t.campos,{chave:a.chave}),a.coluna=void 0,a.regrasDeValor=void 0,this.validarMapa())}},{key:"aplicarRegrasDeValor",value:function(o){var a=this;return this.campos.forEach(function(t){if(t.tipo===Object){if(t.coluna){var e=i.find(a.colunas,{numero:t.coluna}),s=i.groupBy(o,function(o){return o[e.nome]});t.regrasDeValor=Object.keys(s).map(function(o){return{valor:"undefined"===o?"":o,quantidade:s[o].length,objeto:t.objetoAutoVinculo(o)}})}else t.regrasDeValor=[{valor:null,geral:!0,quantidade:o.length,objeto:null}];t.objetoRegrasDeValor&&t.objetoRegrasDeValor(a.campos)}}),this.resumirRegrasDeValor()}},{key:"resumirRegrasDeValor",value:function(){var o=0,a=0,t=0,e=0;return this.campos.forEach(function(s){if(s.tipo===Object){if(s.coluna)s.resumoRegrasDeValor={valores:0,vinculados:0,nulosValidos:0,nulosInvalidos:0},s.regrasDeValor.forEach(function(o){!o.objeto&&s.obrigatorio?s.resumoRegrasDeValor.nulosInvalidos++:o.objeto?s.resumoRegrasDeValor.vinculados++:s.resumoRegrasDeValor.nulosValidos++,s.resumoRegrasDeValor.valores++});else{var i=!!s.regrasDeValor[0].objeto;s.resumoRegrasDeValor={valores:1,vinculados:i?1:0,nulosValidos:i||s.obrigatorio?0:1,nulosInvalidos:!i&&s.obrigatorio?1:0}}o+=s.resumoRegrasDeValor.valores,a+=s.resumoRegrasDeValor.vinculados,t+=s.resumoRegrasDeValor.nulosValidos,e+=s.resumoRegrasDeValor.nulosInvalidos}}),{valores:o,vinculados:a,nulosValidos:t,nulosInvalidos:e}}},{key:"montarLote",value:function(a,t,r){var n=this,l={nomeArquivo:t};return l=new s(l),a.forEach(function(a,t){var s=new e(t+2);n.campos.forEach(function(t){if(t.possuiVinculoOuRegraGeral()||t.obrigatorio){if(t.dado=void 0,!!t.coluna){var e=i.find(n.colunas,{numero:t.coluna});t.dado=a[e.nome]}t.validar(),t.valido||(t.obrigatorio?(s.objeto.invalido=!0,s.possuiErro=!0,s.possuiConflito=!1):!s.possuiErro&&(s.possuiConflito=!0)),t.mensagens.forEach(function(o){s.resumo.mensagens.push(o)}),s.objeto[t.chave]=t.valor,s.resumo.campos.push({valido:t.valido,chave:t.chave,dado:t.dado,referencia:t.referencia,template:o.copy(t.template)})}}),!r||!0!==r.itens[t].desconsiderado||(s.desconsiderado=!0),l.itens.push(s)}),l.resumir(),l}}]),a}();return r}])}(angular),function(o){o.module("alt.importacao-csv").factory("AltImportacaoCsvOpcoesModel",["$q",function(a){var t=function(){function t(e){_classCallCheck(this,t),this.labelTipo="",this.labelTipoSingular="",this.eventoCriacao="",this.campos=void 0,this.validarLote=void 0,this.gravarLote=void 0,this.visualizacao=!1,this.loteProcessado=void 0,this.titulosMensagensCustomizadas=[],this.obterItensNaoImportados=function(){return a.resolve([])},this.obterItensImportadosComAviso=function(){return a.resolve([])},o.extend(this,e),this._parseVisualizacao(),this._validarOpcoes()}return _createClass(t,[{key:"_parseVisualizacao",value:function(){this.visualizacao=!!this.visualizacao}},{key:"_validarOpcoes",value:function(){if(!this.labelTipo)throw new Error('Parametro "labelTipo" é obrigatório.');if(!this.campos)throw new Error('Parametro "campos" é obrigatório.');if(this.visualizacao){if(!this.labelTipoSingular)throw new Error('Parametro "labelTipoSingular" é obrigatório quando em visualização.');if(!this.loteProcessado)throw new Error('Parametro "loteProcessado" é obrigatório quando em visualização.')}else{if(!this.eventoCriacao)throw new Error('Parametro "eventoCriacao" é obrigatório quando em importação.');if(!this.validarLote)throw new Error('Parametro "validarLote" é obrigatório quando em importação.');if(!this.gravarLote)throw new Error('Parametro "gravarLote" é obrigatório quando em importação.')}}},{key:"obterTitulosMensagensPorStep",value:function(o){if(!this.titulosMensagensCustomizadas||!this.titulosMensagensCustomizadas.length)return null;var a=this.titulosMensagensCustomizadas.filter(function(a){return a.step===o});return a&&a.length?a[0]:null}}]),t}();return t}])}(angular),function(o){o.module("alt.importacao-csv").factory("AltImportacaoCsvOpcoesTituloMensagemModel",[function(){return function o(a,t,e){_classCallCheck(this,o),this.step=a,this.title=t,this.message=e}}])}(angular),function(o){o.module("alt.importacao-csv").factory("AltImportacaoCsvResumoItemModel",[function(){return function o(a){_classCallCheck(this,o),this.linha=a,this.status="",this.campos=[],this.mensagens=[]}}])}(angular);