"use strict";function _classCallCheck(a,o){if(!(a instanceof o))throw new TypeError("Cannot call a class as a function")}var _createClass=function(){function a(a,o){for(var e,t=0;t<o.length;t++)e=o[t],e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(a,e.key,e)}return function(o,e,t){return e&&a(o.prototype,e),t&&a(o,t),o}}();!function(a){a.module("alt.importacao-csv",["alt.modal-service","alt.select-service","alt.alerta-flutuante","alt.carregando-info"]).constant("AltImportacaoCsvEvento",{modal:{ABRE_MODAL_IMPORTACAO_ESPECIFICA:"alt-importacao-csv:abrir_modal_importacao_especifica"}}).constant("latinize",latinize).constant("_",_).constant("moment",moment).constant("XLS",XLS).constant("XLSX",XLSX)}(angular),function(a){a.module("alt.importacao-csv").service("AltImportacaoCsvEspecificaService",["$rootScope","AltImportacaoCsvEvento",function(a,o){this.exibe=function(e){a.$broadcast(o.modal.ABRE_MODAL_IMPORTACAO_ESPECIFICA,e)}}]).directive("altImportacaoCsvEspecifica",[function(){return{restrict:"A",replace:!0,template:'\n    <div class="modal fade"\n      id="alt-importacao-csv-modal"\n      role="dialog"\n      aria-hidden="true">\n\n      <div class="modal-dialog modal-lg">\n        <div class="modal-content">\n\n          <div class="modal-header alt-cor-principal">\n            <button type="button" class="close" data-dismiss="modal">\n              <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>\n            </button>\n\n            <h3 class="modal-title">Nova Importação - {{importacaoCsvCtrl.labelTipo}}</h3>\n          </div>\n          <div class="alt-importacao-csv-wizard-menu">\n            <div class="modal-body">\n              <div class="row">\n                <div ng-repeat="step in importacaoCsvCtrl.steps" class="col-xs-3 text-center alt-importacao-csv-step-title-wrap" ng-hide="step.menuHidden">\n                  <div class="row">\n                    <div class="col-xs-12">\n                      <button type="button" class="alt-importacao-csv-step-title" \n                        ng-class="{\n                          \'alt-importacao-csv-step-title-completed\': step.completed, \n                          \'alt-importacao-csv-step-title-active\': step.active,\n                          \'alt-importacao-csv-step-title-invalid\': !step.valid}">\n                          {{step.number}}\n                      </button>\n                    </div>\n                  </div>\n                  <div class="row">\n                    <div class="col-xs-12 alt-importacao-csv-step-subtitle"\n                      ng-class="{\n                        \'alt-importacao-csv-step-subtitle-completed\': step.completed, \n                        \'alt-importacao-csv-step-subtitle-active\': step.active,\n                        \'alt-importacao-csv-step-subtitle-invalid\': !step.valid}">\n                      <span class="text-uppercase text-center">{{step.name}}</span>\n                    </div>\n                  </div>\n                </div>\n              </div>\n              <div class="row">\n                <div class="col-xs-12 alt-importacao-csv-progress-wrapper">\n                  <uib-progressbar class="progress-striped active" value="importacaoCsvCtrl.progress" type="info">\n                  </uib-progressbar>\n                </div>\n              </div>\n              <div class="row">\n                <div class="col-xs-12 alt-espacamento-top text-center alt-importacao-csv-file-label">\n                  <span ng-show="!!importacaoCsvCtrl.arquivo">{{importacaoCsvCtrl.arquivo.nome}}</span>\n                </div>\n              </div>\n            </div>\n          </div>\n          <div class="alt-importacao-csv-wrapper">\n            <div ng-show="importacaoCsvCtrl.steps[0].active"\n              class="alt-importacao-csv-wizard-step alt-espacamento-bottom">\n              <div class="modal-body">\n                <form name="importacaoCsvCtrl.formStepOne">\n                  <div class="row">\n                    <div class="col-xs-12">\n                      <div class="alt-importacao-csv-wizard-title">Selecione o arquivo</div>\n                      <p class="alt-importacao-csv-wizard-obs alt-espacamento-top">\n                        <i class="fa fa-info-circle text-secondary"></i>&nbsp; São aceitos documentos de extensão xls, xlsx, ods ou csv.\n                      <p>\n                      <div class="alt-espacamento-top">\n                          <div class="anexos-input-file-escondido-container">\n                            <button type="button" class="col-xs-12 col-sm-3 btn btn-default alt-espacamento-bottom alt-espacamento-top anexos-input-file-fake">\n                              <i class="fa fa-file-excel-o"></i>&nbsp; Selecionar arquivo\n                            </button>\n\n                            <input type="file" class="anexos-input-file-real alt-hand col-xs-12 col-sm-3 ng-isolate-scope" \n                              ng-model="importacaoCsvCtrl.arquivo" \n                              id="alt-importacao-csv-input-file-step1"\n                              accept=".xls,.xlsx,.csv,.ods"\n                              alt-importacao-csv-leitor\n                              ng-change="importacaoCsvCtrl.arquivoAlterado(0)"\n                              required>\n                          </div>\n                          <span ng-show="importacaoCsvCtrl.arquivo.valido" class="text-success alt-importacao-csv-input-ckeck">\n                            <i class="fa fa-check-circle"></i>&nbsp; {{importacaoCsvCtrl.arquivo.nome}}\n                          </span>\n                          <span ng-show="importacaoCsvCtrl.formStepOne.file.$valid && !importacaoCsvCtrl.arquivo.valido" \n                            class="text-danger alt-importacao-csv-input-ckeck">\n                            <i class="fa fa-times-circle"></i>&nbsp; {{importacaoCsvCtrl.arquivo.mensagem}}\n                          </span>\n                      </div>\n                    </div>\n                  </div>\n                </form>\n              </div>\n            </div>\n            <div ng-show="importacaoCsvCtrl.steps[1].active"\n              class="alt-importacao-csv-wizard-step alt-espacamento-bottom">\n              <div class="modal-body">\n                <div class="row">\n                  <div class="col-xs-12">\n                    <div class="alt-importacao-csv-wizard-title">Mapeie os campos com as colunas do arquivo</div>\n                  </div>\n                </div>\n                <div class="row alt-importacao-csv-form-binding">\n                  <form name="importacaoCsvCtrl.formBinding">\n                    <div class="col-md-4">\n                      <label>Campo</label>\n                      <select id="alt-importacao-csv-select-field"\n                        name="field" ng-model="importacaoCsvCtrl.campoSelecionado"\n                        ng-options="campo as campo.nome for campo in importacaoCsvCtrl.importacao.campos | filter: importacaoCsvCtrl.campoNaoMapeado track by campo.chave"\n                        ng-change="importacaoCsvCtrl.validarMapeamentoColunas()"\n                        required>\n                      </select>\n                    </div>\n                    <div class="col-md-4">\n                      <label>Coluna</label>\n                      <select id="alt-importacao-csv-select-column"\n                        name="column" ng-model="importacaoCsvCtrl.colunaSelecionada"\n                        ng-options="c as c.titulo for c in importacaoCsvCtrl.importacao.colunas"\n                        required>\n                      </select>\n                    </div>\n                    <div class="col-md-4">\n                      <label class="alt-visibility-hidden alt-display-block">.</label>\n                      <button type="button" class="btn btn-default"\n                        ng-disabled="!importacaoCsvCtrl.campoSelecionado.chave || !importacaoCsvCtrl.colunaSelecionada.numero"\n                        ng-click="importacaoCsvCtrl.vincular(\n                          importacaoCsvCtrl.campoSelecionado.chave,\n                          importacaoCsvCtrl.colunaSelecionada.numero)">\n                        <i class="fa fa-exchange"></i>&nbsp; Vincular\n                      </button>\n                      <button type="button" class="btn btn-default pull-right text-secondary"\n                        ng-click="importacaoCsvCtrl.deParaDefault()">\n                        <i class="fa fa-list"></i>\n                      </button>\n                    </div>\n                  </form>\n                </div>\n                <div class="row alt-espacamento-top">\n                  <div class="col-xs-12">\n                    <table class="table table-responsive table-condensed table-striped">\n                      <thead>\n                        <tr>\n                          <th>Campo</th>\n                          <th>Nome Coluna</th>\n                          <th>Nº Coluna</th>\n                          <th></th>\n                        </tr>\n                      </thead>\n                      <tbody>\n                        <tr ng-repeat="campo in importacaoCsvCtrl.importacao.campos" ng-show="campo.coluna">\n                          <td>{{campo.nome}}</td>\n                          <td>{{campo.coluna.nome}}</td>\n                          <td>{{campo.coluna.numero}}</td>\n                          <td><button type="button" class="btn btn-default pull-right" ng-click="importacaoCsvCtrl.desvincular(campo.chave)">Desvincular</button></td>\n                        </tr>\n                      </tbody>\n                    </table>\n                  </div>\n                </div>\n                <div class="row">\n                  <div class="col-xs-12 alt-importacao-csv-map-warnings">\n                    <p ng-repeat="campo in importacaoCsvCtrl.importacao.campos" ng-if="campo.vinculoRequisitado">\n                      <i class="fa fa-exclamation-triangle"></i> \n                      <span>O campo <b>{{campo.nome}}</b> deve ser vinculado a uma coluna do documento.</span>\n                    </p>\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div ng-show="importacaoCsvCtrl.steps[2].active"\n              class="alt-importacao-csv-wizard-step alt-espacamento-bottom">\n              <div class="modal-body">\n                <div class="row">\n                  <div class="col-xs-12">\n                    <div class="alt-importacao-csv-wizard-title">Configure as regras de valor para os campos de cadastros</div>\n                  </div>\n                </div>\n                <div class="row alt-espacamento-bottom">\n                  <div class="col-md-12 alt-espacamento-bottom">\n                    <div class="btn-group" data-toggle="buttons" id="alt-importacao-csv-btn-group-rules">\n                      <label class="btn btn-default text-secondary" ng-click="importacaoCsvCtrl.resumoRegrasDeValor.exibir = \'todos\';" >\n                        <input type="radio" name="toggleRulesMenu" autocomplete="off">\n                        {{importacaoCsvCtrl.resumoRegrasDeValor.valores}} valores\n                      </label>\n                      <label class="btn btn-default text-success" \n                        ng-show="importacaoCsvCtrl.resumoRegrasDeValor.vinculados > 0"\n                        ng-click="importacaoCsvCtrl.resumoRegrasDeValor.exibir = \'regras\';">\n                        <input type="radio" name="toggleRulesMenu" id="menu1" autocomplete="off">\n                        <i class="fa fa-check-circle"></i>&nbsp; {{importacaoCsvCtrl.resumoRegrasDeValor.vinculados}} regras\n                      </label>\n                      <label class="btn btn-default text-warning" \n                        ng-show="importacaoCsvCtrl.resumoRegrasDeValor.nulosInvalidos > 0"\n                        ng-click="importacaoCsvCtrl.resumoRegrasDeValor.exibir = \'nulosInvalidos\';" >\n                        <input type="radio" name="toggleRulesMenu" id="menu2" autocomplete="off">\n                        <i class="fa fa-exclamation-circle"></i>&nbsp; {{importacaoCsvCtrl.resumoRegrasDeValor.nulosInvalidos}} valores obrigatórios sem regra\n                      </label>\n                      <label class="btn btn-default" \n                        ng-show="importacaoCsvCtrl.resumoRegrasDeValor.nulosValidos > 0"\n                        ng-click="importacaoCsvCtrl.resumoRegrasDeValor.exibir = \'nulosValidos\';">\n                        <input type="radio" name="toggleRulesMenu" id="menu3" autocomplete="off">\n                        <i class="fa fa-info-circle text-secondary"></i>&nbsp; {{importacaoCsvCtrl.resumoRegrasDeValor.nulosValidos}} valores opcionais sem regra\n                      </label>\n                    </div>\n                  </div>\n                </div>\n                <div class="row alt-espacamento-top">\n                  <div class="col-xs-12 alt-importacao-csv-rules-field" \n                    ng-repeat="campo in importacaoCsvCtrl.importacao.campos track by campo.chave" \n                    ng-if="campo.tipo.name === \'Object\'"\n                    ng-hide="\n                      (importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'regras\' && campo.resumoRegrasDeValor.vinculados === 0) ||\n                      (importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosInvalidos\' && campo.resumoRegrasDeValor.nulosInvalidos === 0) ||\n                      (importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosValidos\' && campo.resumoRegrasDeValor.nulosValidos === 0)">\n                    <div class="row alt-espacamento-top">\n                      <div class="col-xs-12">\n                        <label class="alt-importacao-csv-rules-title" data-toggle="collapse" data-target="#alt-importacao-csv-rules-field-{{campo.chave}}">\n                          <i class="fa fa-angle-down"></i>\n                          {{campo.nome}} \n                          <span ng-show="!!campo.coluna">(coluna {{campo.coluna.nome.toLowerCase()}})</span>\n                        </label>\n                      </div>\n                    </div>\n                    <div class="row alt-espacamento-bottom collapse in" id="alt-importacao-csv-rules-field-{{campo.chave}}">\n                      <div class="col-xs-12 alt-importacao-csv-rule-table">\n                        <table class="table table-responsive table-condensed table-striped">\n                          <thead>\n                            <tr>\n                              <th class="status"></th>\n                              <th>Valor</th>\n                              <th>Ocorrências</th>\n                              <th>Regra</th>\n                            </tr>\n                          </thead>\n                          <tbody>\n                            <tr ng-repeat="regra in campo.regrasDeValor"\n                              ng-class="{\n                                \'rule-success\': regra.objeto,\n                                \'rule-warning\': !regra.objeto && !campo.obrigatorio,\n                                \'rule-error\': !regra.objeto && campo.obrigatorio}"\n                              ng-hide="\n                                (!regra.objeto && importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'regras\') ||\n                                ((!regra.objeto && campo.obrigatorio || regra.objeto) && importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosValidos\') ||\n                                ((!regra.objeto && !campo.obrigatorio || regra.objeto) && importacaoCsvCtrl.resumoRegrasDeValor.exibir === \'nulosInvalidos\')">\n                              <td class="status">\n                                <i class="fa fa-exclamation-triangle text-warning" ng-show="!regra.objeto && campo.obrigatorio"></i>\n                                <i class="fa fa-check text-success" ng-show="regra.objeto"></i>\n                              </td>\n                              <td ng-hide="regra.geral">{{regra.valor}}</td>\n                              <td ng-show="regra.geral"><i class="text-secondary">Todas as ocorrências</i></td>\n                              <td class="alt-importacao-csv-rules-td-count-field">{{regra.quantidade}}</td>\n                              <td class="alt-importacao-csv-rules-td-select-field">\n                                <select id="alt-importacao-csv-rules-select-{{campo.chave}}-{{$index}}"\n                                  class="alt-importacao-csv-rules-select"\n                                  style="width: 100%;"\n                                  ng-model="regra.objeto"\n                                  ng-change="importacaoCsvCtrl.resumirRegrasDeValor()"\n                                  ng-options="{{importacaoCsvCtrl.ngOptionsRegraDeCampo(campo)}}">\n                                </select>\n                              </td>\n                            </tr>\n                          </tbody>\n                        </table>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n            <div ng-show="importacaoCsvCtrl.steps[3].active"\n              class="alt-importacao-csv-wizard-step alt-espacamento-bottom">\n              <div class="modal-body">\n                <div class="row">\n                  <div class="col-xs-12">\n                    <div class="alt-importacao-csv-wizard-title">Confira o relatório de {{importacaoCsvCtrl.labelTipo.toLowerCase()}}</div>\n                  </div>\n                </div>\n                <div class="row alt-espacamento-bottom">\n                  <div class="col-md-12 alt-espacamento-bottom">\n                    <div class="btn-group" data-toggle="buttons" id="alt-importacao-csv-btn-group-review">\n                      <label class="btn btn-default text-secondary" ng-click="importacaoCsvCtrl.lote.exibir = \'todos\';" >\n                        <input type="radio" name="toggleRulesMenu" autocomplete="off">\n                        {{importacaoCsvCtrl.lote.itens.length}} linhas\n                      </label>\n                      <label class="btn btn-default text-success" \n                        ng-show="importacaoCsvCtrl.lote.validos > 0"\n                        ng-click="importacaoCsvCtrl.lote.exibir = \'validos\';">\n                        <input type="radio" name="toggleLoteMenu" id="menuLote1" autocomplete="off">\n                        <i class="fa fa-check-circle"></i>&nbsp; {{importacaoCsvCtrl.lote.validos}} válidas\n                      </label>\n                      <label class="btn btn-default text-danger" \n                        ng-show="importacaoCsvCtrl.lote.erros > 0"\n                        ng-click="importacaoCsvCtrl.lote.exibir = \'erros\';" >\n                        <input type="radio" name="toggleLoteMenu" id="menuLote2" autocomplete="off">\n                        <i class="fa fa-times-circle"></i>&nbsp; {{importacaoCsvCtrl.lote.erros}} com erro\n                      </label>\n                      <label class="btn btn-default" \n                        ng-show="importacaoCsvCtrl.lote.conflitos > 0"\n                        ng-click="importacaoCsvCtrl.lote.exibir = \'conflitos\';">\n                        <input type="radio" name="toggleLoteMenu" id="menuLote3" autocomplete="off">\n                        <i class="fa fa-exclamation-circle text-secondary"></i>&nbsp; {{importacaoCsvCtrl.lote.conflitos}} com aviso\n                      </label>\n                      <label class="btn btn-default" \n                        ng-show="importacaoCsvCtrl.lote.desconsiderados > 0"\n                        ng-click="importacaoCsvCtrl.lote.exibir = \'desconsiderados\';">\n                        <input type="radio" name="toggleLoteMenu" id="menuLote4" autocomplete="off">\n                        <i class="fa fa-info-circle text-secondary"></i>&nbsp; {{importacaoCsvCtrl.lote.desconsiderados}} desconsideradas\n                      </label>\n                    </div>\n                  </div>\n                </div>\n                <div class="row alt-espacamento-top">\n                  <div class="col-xs-12">\n                    <div class="row"\n                      ng-repeat="item in importacaoCsvCtrl.lote.itens"\n                      ng-hide="\n                        ((item.possuiErro || item.possuiConflito || item.desconsiderado) && importacaoCsvCtrl.lote.exibir === \'validos\') || \n                        ((!item.possuiErro || item.desconsiderado) && importacaoCsvCtrl.lote.exibir === \'erros\') || \n                        ((!item.possuiConflito || item.desconsiderado) && importacaoCsvCtrl.lote.exibir === \'conflitos\') ||\n                        (item.desconsiderado !== true && importacaoCsvCtrl.lote.exibir === \'desconsiderados\')">\n                      <div class="col-xs-12">\n                        <div class="col-xs-12 alt-importacao-csv-report"\n                          ng-class="{\n                            \'alt-importacao-csv-report--error\': item.possuiErro,\n                            \'alt-importacao-csv-report--warning\': item.possuiConflito,\n                            \'alt-importacao-csv-report--disabled\': item.desconsiderado}">\n                          <div class="row">\n                            <div class="col-md-12 alt-importacao-csv-report-row-head">\n                              <span>Linha</span> <span ng-bind="item.resumo.linha"></span>\n                              <a class="pull-right" ng-hide="item.desconsiderado" ng-click="importacaoCsvCtrl.lote.desconsiderarItem($index)">Desconsiderar</a>\n                              <a class="pull-right" ng-show="item.desconsiderado" ng-click="importacaoCsvCtrl.lote.considerarItem($index)">Habilitar</a>\n                            </div>\n                          </div>\n                          <div class="row alt-importacao-csv-report-row-body">\n                            <div ng-repeat="campo in item.resumo.campos" class="col-md-{{campo.template.width}}">\n                              <label ng-bind="campo.template.label"></label>\n                                <span ng-show="campo.valido" ng-bind="campo.referencia"></span>\n                                <span ng-hide="campo.valido">\n                                  {{campo.dado}} <i class="fa fa-times-circle text-danger"></i>\n                                </span>\n                            </div>\n                          </div>\n                          <div class="row" ng-show="item.resumo.mensagens.length > 0">\n                            <div class="col-md-12 alt-importacao-csv-report-row-footer">\n                              <div class="alt-importacao-csv-report-message" ng-repeat="msg in item.resumo.mensagens">\n                                <i class="fa fa-exclamation-triangle text-warning"></i>&nbsp;\n                                <span ng-bind-html="msg.textoHtml" ng-show="!!msg.textoHtml"></span>\n                                <span ng-bind="msg.texto" ng-show="!msg.textoHtml"></span>\n                              </div>\n                            </div>\n                          </div>\n                        </div>\n                      </div>\n                    </div>\n                  </div>\n                </div>\n              </div>\n            </div>\n          </div>\n          <div class="modal-footer">\n            <button type="button" class="btn btn-default pull-left" \n              ng-click="importacaoCsvCtrl.prevStep()"\n              ng-hide="importacaoCsvCtrl.steps[0].active">\n              <i class="fa fa-long-arrow-left"></i>&nbsp; Anterior\n            </button>\n            <div class="anexos-input-file-escondido-container anexos-input-file-escondido-container-inline" ng-show="importacaoCsvCtrl.permiteAlteracaoArquivo()">\n              <button type="button" class="col-xs-12 btn btn-default anexos-input-file-fake">\n                <span><i class="fa fa-refresh"></i>&nbsp; Recarregar arquivo</span>\n              </button>\n              <input type="file" class="anexos-input-file-real alt-hand col-xs-12 ng-isolate-scope" \n                  ng-model="importacaoCsvCtrl.arquivo"\n                  accept=".xls,.xlsx,.csv,.ods"\n                  name="file"\n                  alt-importacao-csv-leitor\n                  ng-change="importacaoCsvCtrl.arquivoAlterado()"\n                  required>\n            </div>\n            <button type="button" class="btn btn-primary"\n              ng-hide="importacaoCsvCtrl.steps[3].active"\n              ng-disabled="importacaoCsvCtrl.invalidStep()"\n              ng-click="importacaoCsvCtrl.nextStep()">\n              Próximo &nbsp;<i class="fa fa-long-arrow-right"></i>\n            </button>\n            <button type="button" class="btn btn-primary"\n              ng-show="importacaoCsvCtrl.steps[3].active"\n              ng-disabled="importacaoCsvCtrl.invalidStep()"\n              ng-click="importacaoCsvCtrl.salvarImportacao()">\n              Gravar\n            </button>\n            <button type="button" class="btn btn-default"\n              data-dismiss="modal">\n              Cancelar\n            </button>\n          </div>\n        </div>\n      </div>\n    </div>',scope:{},controller:["$rootScope","$scope","$sce","$timeout","AltModalService","AltSelectService","AltAlertaFlutuanteService","AltImportacaoCsvCampoModel","AltImportacaoCsvModel","AltImportacaoCsvEvento",function(o,e,t,i,s,n,r,l,c,d){var p=this,v="#alt-importacao-csv-modal",u="#alt-importacao-csv-select-field",m="#alt-importacao-csv-select-column",g="#alt-importacao-csv-rules-select",b="#alt-importacao-csv-btn-group-rules",f=function(){var a=$(window).height()-60;$(v).find(".modal-content").css("max-height",a+"px"),$(v).find(".alt-importacao-csv-wrapper").css("max-height",a-220+"px")},h=function(a,o){var e=$(a).find('input[type="radio"]');e.removeAttr("checked"),e.parent("label").removeClass("active"),$(e[o]).attr("checked","checked"),$(e[o]).parent("label").addClass("active")},C=function(){p.importacao=new c(p.campos);var a=p.arquivo.linhas[0];Object.keys(a).map(function(a,o){p.importacao.adicionarColuna(a,o)}),p.importacao.validarMapa(),n.inicializar(u),n.inicializar(m)},x=function(){p.resumoRegrasDeValor=p.importacao.aplicarRegrasDeValor(p.arquivo.linhas),p.importacao.campos.forEach(function(a){a.tipo===Object&&a.regrasDeValor.forEach(function(o,e){var t=g+"-"+a.chave+"-"+e;a.objetoCriarNovo?p.inicializarComboComOpcaoCriarNovo(t,a.chave,e):n.inicializar(t)})}),p.resumoRegrasDeValor.exibir="todos",h(b,0)},y=function(){var a=p.importacao.montarLote(p.arquivo.linhas,p.lote);p.validarLote(a).then(function(a){p.lote=a,p.lote.exibir="todos",h("#alt-importacao-csv-btn-group-review",0)})},w=function(o){p.labelTipo=o.labelTipo,p.validarLote=o.validarLote,p.gravarLote=o.gravarLote,p.eventoCriacao=o.eventoCriacao,p.campos=a.copy(o.campos),p.camposConfigurados=a.copy(o.campos),p.campoSelecionado=null,p.colunaSelecionada=null,p.arquivoAnterior=null,p.arquivo=null,p.lote=null,p.steps=[{name:"Arquivo",number:1,active:!0,progress:12.6},{name:"Mapeamento",number:2,progress:37.5,init:C},{name:"Regras",number:3,progress:62.5,init:x},{name:"Revisão",init:y,number:4,progress:87.7}],p.progress=p.steps[0].progress,f()};p.nextStep=function(){var a=_.findIndex(p.steps,{active:!0}),o=p.steps[a],e=p.steps[a+1];o.active=!1,o.completed=!0,e.active=!0,p.progress=e.progress,e.init()},p.prevStep=function(){var a=_.findIndex(p.steps,{active:!0});p.steps[a].active=!1,p.steps[a].completed=!1,p.steps[a-1].active=!0,p.progress=p.steps[a-1].progress},p.reloadStep=function(a){var o=p.steps[a];!o||!o.init||o.init()},p.invalidStep=function(){var a=_.findIndex(p.steps,{active:!0});return 0===a?!p.arquivo||!p.arquivo.valido:1===a?p.importacao.mapaInvalido:2===a?0<p.resumoRegrasDeValor.nulosInvalidos:!(3!==a)&&p.lote&&0!==p.lote.erros},p.vincular=function(a,o){p.importacao.vincular(a,o),p.colunaSelecionada={},p.campoSelecionado={},n.inicializar(u),n.inicializar(m),p.formBinding.$setPristine(),i(function(){$($(u).next("span").find(".select2-selection")).focus()},300)},p.desvincular=function(a){p.importacao.desvincular(a),p.colunaSelecionada={},p.campoSelecionado={},n.inicializar(u),n.inicializar(m),p.formBinding.$setPristine()},p.deParaDefault=function(){p.vincular("pessoa",9),p.vincular("categoria",10),p.vincular("dataEmissao",1),p.vincular("data",7),p.vincular("valor",8),p.vincular("baixa_conta",3)},p.campoNaoMapeado=function(o){return a.isUndefined(o.coluna)},p.resumirRegrasDeValor=function(){a.extend(p.resumoRegrasDeValor,p.importacao.resumirRegrasDeValor()),"nulosValidos"===p.resumoRegrasDeValor.exibir&&0===p.resumoRegrasDeValor.nulosValidos&&(p.resumoRegrasDeValor.exibir="todos",h(b,0)),"nulosInvalidos"===p.resumoRegrasDeValor.exibir&&0===p.resumoRegrasDeValor.nulosInvalidos&&(p.resumoRegrasDeValor.exibir="todos",h(b,0))},p.permiteAlteracaoArquivo=function(){var a=_.findIndex(p.steps,{active:!0});return 2===a||3===a},p.arquivoAlterado=function(){var o=_.findIndex(p.steps,{active:!0}),e=0===o;return!p.arquivoAnterior||p.arquivoAnterior.nome===p.arquivo.nome||e?(e&&!!p.arquivoAnterior&&p.arquivoAnterior.nome!==p.arquivo.nome&&(p.campos=a.copy(p.camposConfigurados)),2===o&&p.campos.forEach(function(a){a.regrasDeValor=void 0}),3===o&&(p.lote=void 0),p.arquivoAnterior=a.copy(p.arquivo),void p.reloadStep(o)):(p.arquivo=a.copy(p.arquivoAnterior),r.exibe({msg:"O nome do documento deve coincidir com o do arquivo da importação."}))},p.criarNovoObjetoDeRegra=function(a,o){s.close(v),i(function(){var t=_.find(p.importacao.campos,{chave:a});!t.objetoCriarNovo||!t.objetoCriarNovo.funcao||(t.objetoCriarNovo.funcao(),t.atribuirNovoARegra=o,e.$on(t.objetoCriarNovo.eventoAtualizacao,function(a,o){void 0!==t.atribuirNovoARegra&&(s.open(v),i(function(){t.regrasDeValor[t.atribuirNovoARegra].objeto=o;var a=g+"-"+t.chave+"-"+t.atribuirNovoARegra;p.inicializarComboComOpcaoCriarNovo(a,t.chave,t.atribuirNovoARegra),t.atribuirNovoARegra=void 0,p.resumirRegrasDeValor()},200))}))},200)},p.inicializarComboComOpcaoCriarNovo=function(a,o,t){i(function(){n.inicializarComOpcaoCriarNovo(a,{escopo:e,strMetodo:"importacaoCsvCtrl.criarNovoObjetoDeRegra('"+o+"', "+t+")"},{})})},p.salvarImportacao=function(){var e=a.copy(p.lote);return _.remove(e.itens,function(a){return a.desconsiderado}),p.gravarLote(e,p.arquivo.nome).then(function(a){s.close(v),o.$broadcast(p.eventoCriacao,a)}),!0},p.ngOptionsRegraDeCampo=function(a){var o="",e="";return!a.objetoOpcoesListagem.groupBy||(o="group by obj[campo.objetoOpcoesListagem.groupBy] "),!!a.objetoOpcoesListagem.orderBy&&$.isArray(a.objetoOpcoesListagem.orderBy)&&(e="| orderBy:["+_.map(a.objetoOpcoesListagem.orderBy,function(a){return"'"+a+"'"}).toString()+"]"),"obj as obj[campo.objetoReferencia] "+o+" for obj in campo.objetoListagem() "+e+" track by obj[campo.objetoChave]"},e.$on(d.modal.ABRE_MODAL_IMPORTACAO_ESPECIFICA,function(a,o){w(o),s.open(v)})}],controllerAs:"importacaoCsvCtrl"}}])}(angular),function(a){a.module("alt.importacao-csv").directive("altImportacaoCsvLeitor",["XLS","XLSX","AltCarregandoInfoService",function(a,o,e){return{require:"ngModel",scope:{opts:"="},link:function(t,i,s,n){function r(o){var e={};return o.SheetNames.forEach(function(t){var i=a.utils.sheet_to_row_object_array(o.Sheets[t]);0<i.length&&(e[t]=i)}),e}function l(a){return!("xls"!==a&&"xlsx"!==a&&"csv"!==a&&"ods"!==a)}i.on("change",function(a){e.exibe();var s=new FileReader;s.onload=function(a){var s=a.target.result,c=o.read(s,{type:"binary"}),d=r(c),p=d[Object.keys(d)[0]],v=$(i[0]).val(),u=v?v.split("\\")[2]:"",m=u.split(".")[1],g=l(m),b=g?"":"Tipo de arquivo inválido.";
t.$apply(function(){n.$setViewValue({nome:u,linhas:p,extensao:m,valido:g,mensagem:b}),n.$render(),$(i).val(""),e.esconde()})},s.readAsBinaryString(a.target.files[0])})}}}])}(angular),function(a){a.module("alt.importacao-csv").factory("AltImportacaoCsvCampoModel",["$sce","$filter","moment","latinize",function(o,e,t,i){var s=function(){function s(o){_classCallCheck(this,s),this.nome="",this.chave="",this.obrigatorio=!1,this.dado="",this.coluna=void 0,this.valor=void 0,this.referencia=void 0,this.valido=!1,this.tipo=void 0,this.vinculoRequisitado=!1,this.template={},this.objetoChave=void 0,this.objetoListagem=void 0,this.objetoReferencia=void 0,this.objetoAutoVinculo=void 0,this.objetoCriarNovo=void 0,this.objetoOpcoesListagem={},this.mensagens=[],a.extend(this,o),this._parseObrigatorio(),this._parseObjetoAutoVinculo(),this._parseTipo(),this._parseTemplate(),this._validarOpcoes()}return _createClass(s,[{key:"_validarOpcoes",value:function(){if(!this.nome)throw new Error('Parametro "nome" é obrigatório.');if(!this.chave)throw new Error('Parametro "chave" é obrigatório.');if(this.tipo===Object&&!this.objetoChave)throw new Error('Parametro "objetoChave" é obrigatório para campo Object.');if(this.tipo===Object&&!this.objetoReferencia)throw new Error('Parametro "objetoReferencia" é obrigatório para campo Object.');if(this.tipo===Object&&!this.objetoListagem)throw new Error('Parametro "objetoListagem" é obrigatório para campo Object.')}},{key:"_parseObrigatorio",value:function(){this.obrigatorio=!!this.obrigatorio}},{key:"_parseObjetoAutoVinculo",value:function(){var a=this;this.tipo!==Object||this.objetoAutoVinculo&&"function"==typeof this.objetoAutoVinculo||(this.objetoAutoVinculo=function(o){var e;return o&&(o=i(o.toLowerCase()),a.objetoListagem().forEach(function(t){if(i(t[a.objetoReferencia]).toLowerCase()===o)return void(e=t)})),e})}},{key:"_parseTipo",value:function(){this.tipo!==Object&&this.tipo!==Date&&this.tipo!==Boolean&&this.tipo!==Number&&(this.tipo=String)}},{key:"_parseTemplate",value:function(){this.template={width:"number"==typeof this.template.width?this.template.width:12,label:this.template.label?this.template.label:this.nome}}},{key:"_incluirMensagemValidacao",value:function(a){this.mensagens.push({textoHtml:o.trustAsHtml("O campo <u>"+this.template.label+"</u> "+a+".")})}},{key:"_validarObjeto",value:function(){if(this.regrasDeValor&&0<this.regrasDeValor.length){var a=_.find(this.regrasDeValor,{valor:this.dado});if(a&&a.objeto)this.valor=a.objeto,this.referencia=a.objeto[this.objetoReferencia];else{var o=_.find(this.regrasDeValor,{geral:!0});o&&o.objeto?(this.valor=o.objeto,this.referencia=o.objeto[this.objetoReferencia]):this._incluirMensagemValidacao(this.obrigatorio?"é obrigatório":"não possui regra")}}}},{key:"_validarData",value:function(){var a=t(this.dado,"DD/MM/YYYY");a.isValid()?(this.valor=a.toDate(),this.referencia=a.format("DD/MM/YYYY")):this._incluirMensagemValidacao("não é uma data válida")}},{key:"_validarTexto",value:function(){"string"==typeof this.dado&&255>=this.dado.length?(this.valor=this.dado,this.referencia=this.valor):this._incluirMensagemValidacao("não é um texto válido")}},{key:"_validarNumero",value:function(){this.dado=this.dado.toString().replace(",","."),$.isNumeric(this.dado)?(this.valor=parseFloat(this.dado),this.referencia=this.monetario?e("currency")(this.valor,"R$ "):this.valor):this._incluirMensagemValidacao("não é um número válido")}},{key:"_validarBoleano",value:function(){var a=i(this.dado.toString().toLowerCase());"0"===a||"false"===a||"nao"===a||"n"===a||"f"===a?(this.valor=!1,this.referencia="Não"):"1"===a||"true"===a||"sim"===a||"s"===a||"v"===a?(this.valor=!0,this.referencia="Sim"):this._incluirMensagemValidacao('não é um "verdadeiro ou falso" válido')}},{key:"validar",value:function(){switch(this.valor=void 0,this.referencia=void 0,this.mensagens=[],this.tipo){case Object:this._validarObjeto();break;case Date:this._validarData();break;case String:this._validarTexto();break;case Number:this._validarNumero();break;case Boolean:this._validarBoleano()}this.valido=void 0!==this.valor}},{key:"possuiRegraGeral",value:function(){var a=_.find(this.regrasDeValor,{geral:!0});return!!a&&!!a.objeto}},{key:"possuiVinculoOuRegraGeral",value:function(){return!!this.coluna||this.possuiRegraGeral()}}]),s}();return s}])}(angular),function(a){a.module("alt.importacao-csv").factory("AltImportacaoCsvItemModel",["AltImportacaoCsvResumoItemModel",function(a){return function o(e){_classCallCheck(this,o),this.objeto={},this.resumo=new a(e),this.desconsiderado=!1,this.possuiErro=!1,this.possuiConflito=!1}}])}(angular),function(a){a.module("alt.importacao-csv").factory("AltImportacaoCsvLoteModel",[function(){var a=function(){function a(){_classCallCheck(this,a),this.itens=[],this.erros=0,this.conflitos=0,this.validos=0}return _createClass(a,[{key:"resumir",value:function(){var a=this;this.validos=0,this.erros=0,this.conflitos=0,this.desconsiderados=0,this.itens.forEach(function(o){o.possuiErro?o.desconsiderado?a.desconsiderados++:a.erros++:o.possuiConflito?o.desconsiderado?a.desconsiderados++:a.conflitos++:o.desconsiderado?a.desconsiderados++:a.validos++})}},{key:"aplicarStatusErro",value:function(a){var o=this.itens[a];o.objeto.invalido=!0,o.possuiErro=!0,o.possuiConflito=!1,this.resumir()}},{key:"aplicarStatusAlerta",value:function(a){var o=this.itens[a];o.possuiErro||(o.possuiConflito=!0),this.resumir()}},{key:"desconsiderarItem",value:function(a){var o=this.itens[a];o.desconsiderado=!0,this.resumir()}},{key:"considerarItem",value:function(a){var o=this.itens[a];o.desconsiderado=!1,this.resumir()}}]),a}();return a}])}(angular),function(a){a.module("alt.importacao-csv").factory("AltImportacaoCsvModel",["$sce","$q","AltImportacaoCsvItemModel","AltImportacaoCsvLoteModel","_",function(o,e,t,i,s){var n=function(){function o(a){_classCallCheck(this,o),this.campos=a,this.colunas=[],this.mapaInvalido=!1}return _createClass(o,[{key:"validarMapa",value:function(){var a=this;this.mapaInvalido=!1,this.campos.forEach(function(o){o.tipo===Object||(o.obrigatorio&&!o.coluna?(o.vinculoRequisitado=!0,a.mapaInvalido=!0):o.vinculoRequisitado=!1)})}},{key:"adicionarColuna",value:function(a,o){this.colunas.push({nome:a,numero:o+1,titulo:"Coluna "+(o+1)+" – "+a})}},{key:"vincular",value:function(a,o){var e=s.find(this.campos,{chave:a});!e||(e.coluna=s.find(this.colunas,{numero:o}),this.validarMapa())}},{key:"desvincular",value:function(a){var o=s.find(this.campos,{chave:a});o.coluna=void 0,o.regrasDeValor=void 0,this.validarMapa()}},{key:"aplicarRegrasDeValor",value:function(a){return this.campos.forEach(function(o){if(o.tipo===Object&&!o.regrasDeValor)if(o.coluna){var e=s.groupBy(a,function(a){return a[o.coluna.nome]});o.regrasDeValor=Object.keys(e).map(function(a){return{valor:a,quantidade:e[a].length,objeto:o.objetoAutoVinculo(a)}})}else o.regrasDeValor=[{valor:null,geral:!0,quantidade:a.length,objeto:null}]}),this.resumirRegrasDeValor()}},{key:"resumirRegrasDeValor",value:function(){var a=0,o=0,e=0,t=0;return this.campos.forEach(function(i){if(i.tipo===Object){if(i.coluna)i.resumoRegrasDeValor={valores:0,vinculados:0,nulosValidos:0,nulosInvalidos:0},i.regrasDeValor.forEach(function(a){!a.objeto&&i.obrigatorio?i.resumoRegrasDeValor.nulosInvalidos++:a.objeto?i.resumoRegrasDeValor.vinculados++:i.resumoRegrasDeValor.nulosValidos++,i.resumoRegrasDeValor.valores++});else{var s=!!i.regrasDeValor[0].objeto;i.resumoRegrasDeValor={valores:1,vinculados:s?1:0,nulosValidos:s||i.obrigatorio?0:1,nulosInvalidos:!s&&i.obrigatorio?1:0}}a+=i.resumoRegrasDeValor.valores,o+=i.resumoRegrasDeValor.vinculados,e+=i.resumoRegrasDeValor.nulosValidos,t+=i.resumoRegrasDeValor.nulosInvalidos}}),{valores:a,vinculados:o,nulosValidos:e,nulosInvalidos:t}}},{key:"montarLote",value:function(o,e){var s=this,n=new i;return o.forEach(function(o,i){var r=new t(i+2);s.campos.forEach(function(e){(e.possuiVinculoOuRegraGeral()||e.obrigatorio)&&(e.dado=e.coluna?o[e.coluna.nome]:void 0,e.validar(),!e.valido&&(e.obrigatorio?(r.objeto.invalido=!0,r.possuiErro=!0,r.possuiConflito=!1):!r.possuiErro&&(r.possuiConflito=!0)),e.mensagens.forEach(function(a){r.resumo.mensagens.push(a)}),r.objeto[e.chave]=e.valor,r.resumo.campos.push({valido:e.valido,chave:e.chave,dado:e.dado,referencia:e.referencia,template:a.copy(e.template)}))}),!e||!0!==e.itens[i].desconsiderado||(r.desconsiderado=!0),n.itens.push(r)}),n.resumir(),n}}]),o}();return n}])}(angular),function(a){a.module("alt.importacao-csv").factory("AltImportacaoCsvOpcoesModel",[function(){return function o(e){_classCallCheck(this,o),this.labelTipo="",this.eventoCriacao="",this.campos=[],this.validarLote=void 0,this.gravarLote=void 0,a.extend(this,e)}}])}(angular),function(a){a.module("alt.importacao-csv").factory("AltImportacaoCsvResumoItemModel",[function(){return function a(o){_classCallCheck(this,a),this.linha=o,this.status="",this.campos=[],this.mensagens=[]}}])}(angular);